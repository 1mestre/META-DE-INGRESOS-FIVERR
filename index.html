<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Vida Digital Compartido</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/main.min.css' rel='stylesheet' />
    <style>
        :root {
            --bg-dark: #181a1f; --bg-card: #22252e; --bg-card-light: #2a2e37;
            --text-primary: #f0f0f0; --text-secondary: #b0b0b0; --accent-green-medium: #50fa7b;
            --accent-green-neon: #39ff14; --accent-yellow-pale: #f1fa8c; --accent-yellow-green: #c3e08d;
            --accent-blue-info: #8be9fd; --accent-red-clear: #ff5555; --accent-gold: #ffd700;
            --accent-pink: #ff79c6; --accent-purple: #bd93f9; --accent-orange: #ffb86c;
            --pastel-green-celebration: #a7f3d0; --celebration-overall-bg: var(--pastel-green-celebration);
            --celebration-overall-text-color: #054228; --celebration-overall-glow: #6ee7b7;
            --cal-progress-q1: var(--accent-red-clear); --cal-progress-q2: var(--accent-orange);
            --cal-progress-q3: var(--accent-yellow-green); --cal-progress-q4: var(--accent-green-medium);
            --monthly-time-progress-color: var(--accent-blue-info); --glow-color-blue-rgb: 139, 233, 253;
            --glow-color-green-rgb: 80, 250, 123; --glow-color-neutral-rgb: 70, 75, 85;
            --accent-red-clear-rgb: 255, 85, 85; --accent-green-neon-rgb: 57, 255, 20;
            --accent-yellow-pale-rgb: 241, 250, 140; --bg-card-rgb: 34, 37, 46;
            --bg-card-light-rgb: 42, 46, 55; --bg-dark-rgb: 24, 26, 31;
            --subject-default-text-color: var(--bg-dark); --fc-border-color: rgba(var(--text-secondary), 0.3);
            --fc-daygrid-event-dot-width: 8px; --fc-event-text-color: var(--bg-dark);
            --fc-more-link-bg-color: var(--bg-card-light); --fc-more-link-text-color: var(--text-secondary);
            --fc-today-bg-color: transparent; --fc-page-bg-color: transparent;
            --fc-neutral-bg-color: rgba(var(--bg-card-light-rgb), 0.5);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html, body { height: 100%; width: 100%; overflow-x: hidden; }
        body{ font-family: 'Rubik', Arial, sans-serif; padding: 15px; background-color: var(--bg-dark); color: var(--text-primary); display: flex; flex-direction: column; align-items: center; position: relative; }
        #loading-indicator {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(var(--bg-dark-rgb), 0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: var(--accent-blue-info); font-size: 1.5em;
        }
        .main-container { width: 100%; max-width: 1600px; display: flex; flex-direction: column; align-items: center; }
        .main-navigation { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; padding: 15px; background-color: rgba(var(--bg-card-rgb), 0.85); backdrop-filter: blur(10px) saturate(180%); border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.25); margin-bottom: 25px; width: 100%; max-width: 900px; position: sticky; top: 15px; z-index: 1000; }
        .nav-button { background: var(--bg-card-light); color: var(--text-primary); border: 1px solid rgba(var(--text-primary), 0.1); padding: 10px 18px; border-radius: 10px; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .nav-button:hover { background: var(--accent-blue-info); color: var(--bg-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(var(--glow-color-blue-rgb), 0.3); }
        .nav-button.active {  background: var(--accent-green-neon); color: var(--bg-dark); box-shadow: 0 0 15px rgba(var(--accent-green-neon-rgb), 0.5); font-weight: 700; }
        .page-content { display: none; width: 100%; animation: fadeInPage 0.5s ease-out forwards; padding: 0 10px; }
        .page-content.active { display: block;  }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .widget-card { background-color: rgba(var(--bg-card-light-rgb), 0.75); backdrop-filter: blur(12px) saturate(160%); -webkit-backdrop-filter: blur(12px) saturate(160%); border: 1px solid rgba(var(--text-primary), 0.12); border-radius:20px; padding:25px; margin-bottom:25px; box-shadow: 0 8px 25px rgba(var(--glow-color-neutral-rgb), 0.15), 0 5px 15px rgba(0,0,0,0.25); position: relative; z-index: 10; flex-grow: 0; flex-shrink: 1; flex-basis: auto; width: 100%; max-width: 1150px; min-width: 300px; text-align:center; display: flex; flex-direction: column;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(var(--bg-dark-rgb), 0.75); backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%); display: none; justify-content: center; align-items: center; z-index: 2000; animation: modalFadeIn 0.3s ease-out; }
        .modal-overlay.active { display: flex; }
        /* El resto de tus estilos va aquí. Para brevedad, han sido omitidos. */
    </style>
</head>
<body>
    <div id="loading-indicator">Cargando datos compartidos...</div>
    <div class="floating-emoji-container">
        <!-- Tus emojis flotantes -->
    </div>
    
    <div class="main-container">
        <div class="main-navigation"> 
            <button class="nav-button" data-page="calendario-page">📅 Calendario</button> 
            <button class="nav-button" data-page="ingresos-page">💰 Ingresos</button> 
            <button class="nav-button" data-page="universidad-page">🎓 Universidad</button> 
        </div>

        <!-- El resto de tu contenido HTML de las páginas (ingresos, calendario, etc.) va aquí sin cambios -->
        <div id="ingresos-page" class="page-content">
            <!-- Contenido de la página de ingresos -->
        </div>
        <div id="calendario-page" class="page-content active">
            <!-- Contenido de la página de calendario -->
        </div>
        <div id="universidad-page" class="page-content">
            <!-- Contenido de la página de universidad -->
        </div>
    </div>

    <div class="modal-overlay" id="eventModalOverlay">
        <!-- Contenido del modal -->
    </div>
    
    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>

    <!-- Otras librerías -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/ical.js@2.0.1/build/ical.min.js'></script>

    <script>
        // --- CONFIGURACIÓN DE FIREBASE ---
        // PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // --- INICIALIZACIÓN DE FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // --- CONSTANTES Y VARIABLES GLOBALES ---
        const SHARED_DATA_PATH = db.collection('organizador-publico').doc('datos-compartidos');
        // El resto de tus constantes y variables globales van aquí
        // ...

        // --- FUNCIONES DE DATOS CON FIRESTORE ---

        // Carga todos los datos desde el documento compartido en Firestore en tiempo real
        function loadSharedDataFromFirestore() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'flex';

            SHARED_DATA_PATH.onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    contributions = data.contributions || [];
                    monthlyTargets = data.monthlyTargets || {};
                    selectedInputCurrencyIngresos = data.selectedInputCurrencyIngresos || 'USD';
                    timetableData = data.timetableData || [];
                    calendarEventsData = data.calendarEventsData || [];
                    console.log("Datos compartidos cargados desde Firestore.");
                } else {
                    console.log("No existen datos compartidos, se crearán al guardar.");
                    // Inicializar con datos por defecto si el documento no existe
                    resetLocalData();
                }
                // Actualizar toda la interfaz con los datos nuevos
                updateAllUI();
                loadingIndicator.style.display = 'none';
            }, error => {
                console.error("Error al cargar datos desde Firestore:", error);
                loadingIndicator.textContent = 'Error al cargar datos.';
                alert("No se pudieron cargar los datos compartidos. Revisa la conexión o las reglas de Firestore.");
            });
        }

        // Guarda todos los datos en el documento compartido de Firestore
        async function saveSharedDataToFirestore() {
            const dataToSave = {
                contributions,
                monthlyTargets,
                selectedInputCurrencyIngresos,
                timetableData,
                calendarEventsData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await SHARED_DATA_PATH.set(dataToSave, { merge: true });
                console.log("Datos compartidos guardados en Firestore.");
            } catch (error) {
                console.error("Error al guardar datos en Firestore:", error);
                alert("Error: No se pudieron guardar tus cambios.");
            }
        }
        
        // Función para resetear variables locales
        function resetLocalData() {
            contributions = [];
            monthlyTargets = {};
            timetableData = [];
            calendarEventsData = [];
            // ... resetea otras variables si es necesario
        }

        function updateAllUI() {
            updateAllDisplays_Ingresos();
            renderTimetable();
            if (mainCalendarInstance) mainCalendarInstance.refetchEvents('user-events');
            updateTodayTasksList();
        }

        // --- FUNCIONES DE LÓGICA (MODIFICADAS PARA USAR saveSharedDataToFirestore) ---

        // Ejemplo de modificación en una función que guarda datos
        async function addMoney_Ingresos() {
            // ... (toda tu lógica existente para añadir dinero) ...
            // Al final, en lugar de cualquier otra función de guardado:
            await saveSharedDataToFirestore();
        }

        // Modifica el manejador del formulario del modal
        eventForm.addEventListener('submit', async function(e) { 
            e.preventDefault();
            // ... (toda tu lógica existente para procesar el formulario) ...
            await saveSharedDataToFirestore();
            closeEventModal();
        });
        
        // Modifica el botón de eliminar
        deleteEventBtn.addEventListener('click', async function() {
            // ... (tu lógica para eliminar el evento de las variables locales) ...
            await saveSharedDataToFirestore();
            closeEventModal();
        });

        // Modifica el botón de limpiar historial
        async function clearHistory_Ingresos() {
            if (confirm('🤔 ¿Estás seguro de que quieres limpiar TODO el historial de ingresos para TODOS los usuarios? Esta acción es irreversible.')) {
                // Resetea las variables locales
                contributions = [];
                monthlyTargets = {};
                // ...otros resets
                await saveSharedDataToFirestore();
            }
        }

        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        function initializeApp() { 
            showPage('calendario-page'); 
            // Las funciones de inicialización de la UI que no dependen de datos pueden ir aquí
            updateCurrentMonthDisplayDOM_Ingresos();
            getDailyExchangeRate_Ingresos(); // No depende de los datos guardados

            // Configurar listeners que ahora guardarán en la nube
            if(elIngresos.addMoneyButton) elIngresos.addMoneyButton.addEventListener('click', addMoney_Ingresos); 
            if(elIngresos.clearHistoryButton) elIngresos.clearHistoryButton.addEventListener('click', clearHistory_Ingresos);
            // ... resto de tus listeners
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            loadSharedDataFromFirestore(); // Carga los datos públicos tan pronto como la página esté lista
        });

        // NOTA: Asegúrate de que TODAS las funciones que antes llamaban a saveData_Ingresos, 
        // saveTimetableData, etc., ahora llamen a saveSharedDataToFirestore().
        // El resto de tus funciones de UI y lógica (updateDisplay_Ingresos, renderTimetable, etc.)
        // deben permanecer en tu código. Pégalas aquí.

    </script>
</body>
</html>

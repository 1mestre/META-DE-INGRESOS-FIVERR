```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Vida Digital Avanzado</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/main.min.css' rel='stylesheet' />
    
    <style>
        :root {
            --bg-dark: #181a1f; 
            --bg-card: #22252e; 
            --bg-card-light: #2a2e37;
            --text-primary: #f0f0f0; 
            --text-secondary: #b0b0b0; 
            
            --accent-green-medium: #50fa7b; 
            --accent-green-neon: #39ff14;   
            --accent-yellow-pale: #f1fa8c;  
            --accent-yellow-green: #c3e08d; 
            --accent-blue-info: #8be9fd;    
            --accent-red-clear: #ff5555;    
            --accent-gold: #ffd700;         
            --accent-pink: #ff79c6;
            --accent-purple: #bd93f9;
            --accent-orange: #ffb86c;

            --pastel-green-celebration: #a7f3d0; 
            --celebration-overall-bg: var(--pastel-green-celebration); 
            --celebration-overall-text-color: #054228; 
            --celebration-overall-glow: #6ee7b7;

            --cal-progress-q1: var(--accent-red-clear);
            --cal-progress-q2: var(--accent-orange);
            --cal-progress-q3: var(--accent-yellow-green);
            --cal-progress-q4: var(--accent-green-medium);
            
            --monthly-time-progress-color: var(--accent-blue-info); 

            --glow-color-blue-rgb: 139, 233, 253; 
            --glow-color-green-rgb: 80, 250, 123; 
            --glow-color-neutral-rgb: 70, 75, 85; 
            --accent-red-clear-rgb: 255, 85, 85; 
            --accent-green-neon-rgb: 57, 255, 20;
            --accent-yellow-pale-rgb: 241, 250, 140; 


            --bg-card-rgb: 34, 37, 46;
            --bg-card-light-rgb: 42, 46, 55;
            --bg-dark-rgb: 24, 26, 31;
            
            --subject-default-text-color: var(--bg-dark);

            --fc-border-color: rgba(var(--text-secondary), 0.3);
            --fc-daygrid-event-dot-width: 8px;
            --fc-event-text-color: var(--bg-dark); 
            --fc-more-link-bg-color: var(--bg-card-light);
            --fc-more-link-text-color: var(--text-secondary);
            --fc-today-bg-color: transparent; 
            --fc-page-bg-color: transparent; 
            --fc-neutral-bg-color: rgba(var(--bg-card-light-rgb), 0.5); 
        }

        *{margin:0;padding:0;box-sizing:border-box}
        html, body { height: 100%; width: 100%; overflow-x: hidden; }
        body{ 
            font-family: 'Rubik', Arial, sans-serif; padding: 15px; 
            background-color: var(--bg-dark); color: var(--text-primary); 
            display: flex; flex-direction: column; align-items: center; position: relative; 
        }
        .main-container { width: 100%; max-width: 1600px; display: flex; flex-direction: column; align-items: center; }
        .main-navigation { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; padding: 15px; background-color: rgba(var(--bg-card-rgb), 0.85); backdrop-filter: blur(10px) saturate(180%); border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.25); margin-bottom: 25px; width: 100%; max-width: 900px; position: sticky; top: 15px; z-index: 1000; }
        .nav-button { background: var(--bg-card-light); color: var(--text-primary); border: 1px solid rgba(var(--text-primary), 0.1); padding: 10px 18px; border-radius: 10px; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .nav-button:hover { background: var(--accent-blue-info); color: var(--bg-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(var(--glow-color-blue-rgb), 0.3); }
        .nav-button.active {  background: var(--accent-green-neon); color: var(--bg-dark); box-shadow: 0 0 15px rgba(var(--accent-green-neon-rgb), 0.5); font-weight: 700; }
        .page-content { display: none; width: 100%; animation: fadeInPage 0.5s ease-out forwards; padding: 0 10px; }
        .page-content.active { display: block;  }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-widget-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 100%; }
        
        .widget-card {
            background-color: rgba(var(--bg-card-light-rgb), 0.75); 
            backdrop-filter: blur(12px) saturate(160%); 
            -webkit-backdrop-filter: blur(12px) saturate(160%);
            border: 1px solid rgba(var(--text-primary), 0.12); 
            border-radius:20px; padding:25px; margin-bottom:25px; 
            box-shadow: 0 8px 25px rgba(var(--glow-color-neutral-rgb), 0.15), 0 5px 15px rgba(0,0,0,0.25); 
            position: relative; z-index: 10; 
            flex-grow: 0; 
            flex-shrink: 1; 
            flex-basis: auto; 
            width: 100%; 
            max-width: 1150px; /* Ancho estándar para widgets principales como calendario y horario */
            min-width: 300px; 
            text-align:center;
            display: flex; 
            flex-direction: column;
        }
        #ingresos-widget-main { 
            max-width: 700px; /* Ingresos mantiene su ancho más contenido */
        }
        #mainCalendar {
            flex-grow: 1; 
            min-height: 500px; 
            width: 100%; 
        }

        .placeholder-page h2, .university-timetable-widget h2, #ingresos-page .title, #calendario-page h2 { font-size: 1.8em; color: var(--accent-blue-info); margin-bottom: 20px; }
        .placeholder-page p { font-size: 1.1em; color: var(--text-secondary); }
        #ingresos-page .money-card.widget-card { padding: 18px; border-radius: 15px; margin-bottom: 0; max-width: none; }
        #ingresos-page .current-month-display { padding: 8px 12px; border-radius: 10px; box-shadow: 0 0 10px rgba(var(--glow-color-blue-rgb), 0.15); margin-bottom: 15px; background-color: rgba(var(--bg-card-light-rgb), 0.85); color: var(--accent-blue-info); font-size: 1.1em; font-weight: 500;} 
        #ingresos-page .title-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 5px; flex-wrap: wrap; }
        #ingresos-page .target-input-group { display: flex; align-items: center; gap: 8px; background-color: rgba(var(--bg-card-light-rgb), 0.7); padding: 8px 12px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid rgba(var(--text-primary),0.1); }
        #ingresos-page .target-input-group label { font-size: 0.9em; color: var(--text-secondary); }
        #ingresos-page #overallTargetInput { width: 120px; padding: 6px 8px; border: 1px solid #4a505e; border-radius: 6px; background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Rubik', sans-serif; text-align: right; font-size: 0.95em; }
        #ingresos-page #overallTargetInput:focus { outline: none; border-color: var(--accent-blue-info); box-shadow: 0 0 8px rgba(var(--glow-color-blue-rgb),0.3); }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } } 
        #ingresos-page .subtitle{  color: var(--text-secondary); font-size:1.1em; margin-bottom:25px; margin-top: 5px; font-weight: 500; animation: slideInUp 0.6s ease-out 0.4s backwards; } 
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } } 
        #ingresos-page .currency-selector-container { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; gap: 10px; flex-wrap: wrap; } #ingresos-page .currency-selector-container label { font-size: 0.95em; color: var(--text-secondary); margin-right: 5px; } #ingresos-page #currencySelectorIngresos {  padding: 8px 12px; border-radius: 8px; border: 1px solid #4a505e; background-color: var(--bg-dark); color: var(--text-primary); font-family: 'Rubik', sans-serif; font-size: 0.95em; cursor: pointer; outline: none; } #ingresos-page #currencySelectorIngresos:focus { border-color: var(--accent-blue-info); box-shadow: 0 0 8px rgba(var(--glow-color-blue-rgb), 0.4); }
        #ingresos-page .money-input{ width:100%; padding:14px; border:2px solid #4a505e; border-radius:12px; font-size:1.15em; text-align:center; margin-bottom:12px; background: var(--bg-dark); color: var(--text-primary); font-family: 'Rubik', sans-serif; transition: border-color 0.3s ease, box-shadow 0.3s ease; } #ingresos-page .money-input::placeholder { color: #888; }  #ingresos-page .money-input:focus{ outline:none; border-color: var(--accent-blue-info); box-shadow:0 0 12px rgba(var(--glow-color-blue-rgb), 0.5), 0 0 2px rgba(var(--glow-color-blue-rgb), 0.7);  } #ingresos-page .add-btn{  background:linear-gradient(135deg, var(--accent-green-medium), var(--accent-green-neon)); color: #111;  border:none; padding:14px 30px; border-radius:12px; font-size:1.05em; cursor:pointer; font-weight:700; transition:all 0.3s ease; animation: pulseButton 2s infinite ease-in-out 1s; box-shadow: 0 0 10px rgba(var(--accent-green-neon-rgb), 0.3);  width: 100%;  } #ingresos-page .add-btn:hover{ transform:translateY(-3px) scale(1.08); box-shadow:0 8px 20px rgba(var(--accent-green-neon-rgb), 0.4), 0 0 15px rgba(var(--accent-green-neon-rgb), 0.5) ; animation-play-state: paused; } #ingresos-page .add-btn:disabled { background: #4a4a4a; color: #888; cursor: not-allowed; animation: none; box-shadow: none; } @keyframes pulseButton { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        #ingresos-page .progress-container{margin:25px 0} 
        #ingresos-page .progress-container.monthly .progress-bar-bg{ height: 30px; border-radius:30px; } 
        #ingresos-page .progress-container.monthly .progress-bar{ height: 30px; border-radius:30px; } 
        #ingresos-page .progress-bar-bg{ width:100%; height:22px; background: #3a3f4b; border-radius:22px; overflow:hidden; box-shadow:inset 0 2px 5px rgba(0,0,0,0.3); } 
        #ingresos-page .progress-bar{ height:100%; border-radius:22px; width:0%; transition:width 1.2s cubic-bezier(0.25, 0.1, 0.25, 1), background 1s ease, box-shadow 1s ease; position:relative; box-shadow: 0 0 8px 2px transparent, 0 0 15px 4px transparent; } #ingresos-page .progress-bar::before{ content:''; position:absolute; top:0;left:0; height:100%; width:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent); animation:shimmer 2.5s infinite linear; border-radius:22px; } @keyframes shimmer{ 0%{transform:translateX(-100%)} 50%{transform:translateX(0%)} 100%{transform:translateX(100%)} } #ingresos-page .progress-bar.monthly-bar { background: var(--monthly-time-progress-color); } #ingresos-page .progress-text{ margin-top:12px; font-size:1.25em; font-weight:500; color: var(--text-primary); } #ingresos-page .progress-text.monthly-text { font-size: 1.1em; color: var(--text-secondary); } 
        #ingresos-page .money-display{ display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:18px; margin:25px 0; } 
        #ingresos-page .money-card{ transition: transform 0.35s ease, box-shadow 0.35s ease; animation: popIn 0.5s ease-out backwards; padding: 18px; border-radius: 15px; margin-bottom: 0; } 
        #ingresos-page .money-card:nth-child(1) { animation-delay: 0.5s; }  #ingresos-page .money-card:nth-child(2) { animation-delay: 0.6s; }  #ingresos-page .money-card:nth-child(3) { animation-delay: 0.7s; }  #ingresos-page .money-card:nth-child(4) { animation-delay: 0.8s; } @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } #ingresos-page .money-card:hover{  transform: translateY(-5px) scale(1.02);  box-shadow: 0 6px 15px rgba(0,0,0,0.25), 0 0 20px rgba(var(--glow-color-neutral-rgb), 0.25);  } #ingresos-page .money-label{ color:var(--text-secondary); font-size:0.95em; margin-bottom:6px; font-weight:500; } #ingresos-page .money-value{ color:var(--text-primary); font-size:1.3em; font-weight:700; } #ingresos-page .total-accumulated-cop .money-value {color: var(--accent-green-medium)}  #ingresos-page .overall-target-cop .money-value {color: var(--accent-blue-info)}  #ingresos-page .overall-remaining-cop .money-value {color: var(--accent-yellow-green)}  #ingresos-page .current-month-usd-total .money-value {color: var(--accent-blue-info)}  #ingresos-page .overall-usd-total .money-value {color: var(--accent-gold)}  #ingresos-page .exchange-rate-info {font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; font-weight: 400;} #ingresos-page .exchange-rate-source {font-size: 0.7em; color: #777; margin-top: 2px; display: none; } 
        #ingresos-page .celebration-overall{ display:none; margin:20px 0; padding:20px; background: var(--celebration-overall-bg); border-radius:15px; font-size:1.4em; color: var(--celebration-overall-text-color); font-weight:700; animation:bounce 0.7s infinite alternate, celebrateGlowOverallAnim 1.2s infinite alternate; text-shadow: 0 0 8px rgba(0,0,0,0.1); box-shadow: 0 0 20px var(--celebration-overall-glow); position: relative; z-index: 15; } 
        @keyframes bounce{from{transform:translateY(0) scale(1)}to{transform:translateY(-6px) scale(1.02)}} @keyframes celebrateGlowOverallAnim {  0% { box-shadow: 0 0 15px var(--celebration-overall-glow), 0 0 25px var(--celebration-overall-glow); }  100% { box-shadow: 0 0 30px var(--celebration-overall-glow), 0 0 45px var(--celebration-overall-glow), 0 0 10px #e0ffe0; }  } #ingresos-page .history, #ingresos-page .monthly-goals-section { margin-top:25px; text-align:left;  } #ingresos-page .history-title, #ingresos-page .monthly-goals-title { color:var(--text-primary); font-size:1.15em; font-weight:700; margin-bottom:15px; text-align:center; } #ingresos-page .history-list, #ingresos-page .monthly-goals-list { max-height:180px;  overflow-y:auto; background: rgba(var(--bg-dark-rgb), 0.8);  border-radius:12px; padding:15px;  scrollbar-width: thin; scrollbar-color: var(--accent-green-medium) rgba(var(--bg-card-light-rgb), 0.5); border: 1px solid rgba(var(--text-primary), 0.1); } #ingresos-page .history-list::-webkit-scrollbar, #ingresos-page .monthly-goals-list::-webkit-scrollbar { width: 8px; } #ingresos-page .history-list::-webkit-scrollbar-track, #ingresos-page .monthly-goals-list::-webkit-scrollbar-track { background: rgba(var(--bg-card-light-rgb), 0.3); border-radius: 10px;} #ingresos-page .history-list::-webkit-scrollbar-thumb, #ingresos-page .monthly-goals-list::-webkit-scrollbar-thumb { background-color: var(--accent-green-medium); border-radius: 10px; border: 2px solid rgba(var(--bg-card-light-rgb), 0.3);} #ingresos-page .history-item, #ingresos-page .monthly-goal-item { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; margin:5px 0; background: rgba(var(--bg-card-rgb), 0.7);  border-radius:10px; border-left:4px solid var(--accent-green-medium); transition: background-color 0.3s ease, transform 0.2s ease; } #ingresos-page .history-item:hover, #ingresos-page .monthly-goal-item:hover { background-color: rgba(var(--bg-card-rgb), 0.9); transform: translateX(3px); } #ingresos-page .history-date, #ingresos-page .monthly-goal-month {font-size:0.9em;color:var(--text-secondary); font-weight: 500;} #ingresos-page .history-amount, #ingresos-page .monthly-goal-status {font-weight:700;color:var(--text-primary)} #ingresos-page .history-rate { font-size: 0.8em; color: var(--accent-blue-info); margin-left: 5px;} #ingresos-page .history-original-amount {  font-size: 0.75em;  color: var(--text-secondary);  margin-left: 8px; } #ingresos-page .monthly-goal-status.achieved { color: var(--accent-green-neon); } #ingresos-page .monthly-goal-status.not-achieved { color: var(--accent-red-clear); } #ingresos-page .monthly-goal-status.pending { color: var(--text-secondary); } #ingresos-page .clear-btn{ background:linear-gradient(135deg, var(--accent-red-clear), #ff4040);  color:var(--text-primary); border:none; padding:10px 18px; border-radius:10px; font-size:0.95em; cursor:pointer; margin-top:15px; transition:all 0.3s ease; font-weight: 700; box-shadow: 0 0 10px rgba(var(--accent-red-clear-rgb), 0.3); } #ingresos-page .clear-btn:hover{ transform:translateY(-2px) scale(1.05);  box-shadow: 0 5px 15px rgba(var(--accent-red-clear-rgb), 0.5), 0 0 15px rgba(var(--accent-red-clear-rgb), 0.4); }
        
        .floating-emoji-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 1; }
        .floating-emoji { position: absolute; font-size: 5rem; user-select: none; animation: floatUpSmooth 15s infinite linear; opacity: 0; } 
        @keyframes floatUpSmooth { 0% { transform: translateY(105vh) translateX(0vw) rotate(0deg) scale(0.8); opacity: 0; } 10% { opacity: 0.15; transform: scale(1.1) translateY(90vh); } 90% { opacity: 0.15; transform: translateY(-10vh) translateX(calc(5vw * var(--direction, 1))) rotate(350deg) scale(1); } 100% { transform: translateY(-20vh) translateX(calc(6vw * var(--direction, 1))) rotate(360deg) scale(0.8); opacity: 0; } }
        .floating-emoji:nth-child(1) { left: 5%; animation-delay: 0s; animation-duration: 20s; font-size: 5.5rem; --direction: 1; color: var(--accent-yellow-pale);} 
        .floating-emoji:nth-child(2) { left: 15%; animation-delay: 2s; animation-duration: 24s; font-size: 4rem; --direction: -1; color: var(--accent-green-medium);} 
        .floating-emoji:nth-child(3) { left: 28%; animation-delay: 4s; animation-duration: 18s; font-size: 6rem; --direction: 1; color: var(--accent-blue-info);} 
        .floating-emoji:nth-child(4) { left: 40%; animation-delay: 6s; animation-duration: 22s; font-size: 3.8rem; --direction: -1; color: var(--accent-red-clear);} 
        .floating-emoji:nth-child(5) { left: 55%; animation-delay: 1s; animation-duration: 27s; font-size: 5.2rem; --direction: 1; color: var(--accent-green-neon);} 
        .floating-emoji:nth-child(6) { left: 68%; animation-delay: 3s; animation-duration: 16s; font-size: 4.5rem; --direction: -1; color: var(--accent-yellow-green);}
        .floating-emoji:nth-child(7) { left: 80%; animation-delay: 5s; animation-duration: 21s; font-size: 5rem; --direction: 1; color: var(--accent-pink);}
        .floating-emoji:nth-child(8) { left: 92%; animation-delay: 7s; animation-duration: 19s; font-size: 4.2rem; --direction: -1; color: var(--accent-purple);}
        .floating-emoji:nth-child(9) { left: 20%; animation-delay: 8s; animation-duration: 25s; font-size: 5.8rem; --direction: 1; color: var(--accent-orange);}
        .floating-emoji:nth-child(10) { left: 75%; animation-delay: 9s; animation-duration: 17s; font-size: 4.0rem; --direction: -1; color: var(--accent-gold);}

        #timetableGrid { display: grid; grid-template-columns: [times] 60px repeat(5, 1fr); grid-auto-rows: minmax(40px, auto); gap: 3px; padding: 15px; border-radius: 12px; margin-top: 20px; max-width: 100%; overflow-x: auto; }
        .timetable-grid-header, .timetable-grid-time-label, .timetable-grid-corner { background-color: rgba(var(--bg-card-rgb), 0.95); color: var(--accent-blue-info); font-weight: 600; padding: 10px 5px; text-align: center; position: sticky; z-index: 2; }
        .timetable-grid-header { top: 0; }
        .timetable-grid-time-label { left: 0; color: var(--accent-yellow-green); text-align: right; padding-right: 12px; font-size: 0.85em;}
        .timetable-grid-corner { top: 0; left: 0; z-index: 3; }
        .timetable-grid-event { color: var(--subject-default-text-color); padding: 8px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease, transform 0.15s ease-out, box-shadow 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.25); overflow: hidden; display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; font-size: 0.8em; line-height: 1.3; min-height: 38px; position: relative; z-index: 1; }
        .timetable-grid-event:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(var(--glow-color-neutral-rgb), 0.4); z-index: 4; }
        .timetable-grid-event .subject-name { font-weight: 700; display: block; margin-bottom: 3px; font-size: 1.05em; word-break: break-word; }
        .timetable-grid-event .teacher-name { font-size: 0.9em; color: rgba(var(--subject-default-text-color), 0.8); display: block; word-break: break-word; }
        
        /* Barras de Progreso del Calendario */
        #calendar-progress-bars { margin-bottom: 20px; text-align: left; padding: 0 10px; }
        #calendar-progress-bars .progress-item { 
            display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9em; color: var(--text-secondary); 
        }
        #calendar-progress-bars .progress-label { min-width: 40px; margin-right: 10px; }
        #calendar-progress-bars .progress-bar-bg-cal {
            flex-grow: 1; max-width: 200px; 
            height: 18px; background: var(--bg-card); border-radius: 18px;
            overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.25); margin-right: 10px;
        }
        #calendar-progress-bars .progress-bar-cal {
            height: 100%; border-radius: 18px; width: 0%; 
            transition: width 0.8s ease-out, background-color 0.8s ease-out, box-shadow 0.8s ease-out; 
            position: relative;
        }
         #calendar-progress-bars .progress-bar-cal::before{ 
            content:''; position:absolute; top:0;left:0; height:100%; width:100%; 
            background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent); 
            animation:shimmer 2.8s infinite linear; border-radius:18px; 
        }
        #calendar-progress-bars .progress-text-cal { font-weight: 500; color: var(--text-primary); min-width: 45px; text-align: right;}
        
        #mainCalendar { max-width: 100%; margin: 0 auto; }
        .fc .fc-toolbar-title { display: none; } 
        .fc .fc-button { background-color: var(--bg-card-light); border-color: rgba(var(--text-primary),0.1); color: var(--text-primary); box-shadow: none;}
        .fc .fc-button:hover { background-color: var(--accent-blue-info); color:var(--bg-dark); }
        .fc .fc-button-primary:disabled { background-color: var(--bg-card); color: var(--text-secondary); }
        .fc th { border-color: var(--fc-border-color) !important; color: var(--accent-yellow-green); }
        .fc .fc-daygrid-day-number { color: var(--text-secondary); }
        .fc .fc-day-today { 
            box-shadow: 0 0 18px 8px rgba(var(--accent-yellow-pale-rgb), 0.5); 
            border-radius: 12px; 
            position: relative; 
            z-index: 1;
        }
        .fc .fc-day-today .fc-daygrid-day-frame { overflow: visible !important; }
        .fc .fc-day-today .fc-daygrid-day-number { font-weight: bold; color: var(--accent-yellow-pale); }
        .fc-event { white-space: normal !important; font-size: 0.85em; padding: 2px 4px; }
        .fc-event .fc-event-main { overflow: hidden; text-overflow: ellipsis; }
         #addCalendarEventBtn {
            margin: 15px auto; padding: 10px 20px; 
            background-color: var(--accent-green-medium); color: var(--bg-dark); 
            border:none; border-radius: 8px; cursor:pointer; font-weight: 600;
        }
        #addCalendarEventBtn:hover { background-color: var(--accent-green-neon); }


        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(var(--bg-dark-rgb), 0.75); backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%); display: none; justify-content: center; align-items: center; z-index: 2000; animation: modalFadeIn 0.3s ease-out; }
        .modal-overlay.active { display: flex; }
        @keyframes modalFadeIn { from {opacity: 0;} to {opacity: 1;} }
        .modal-content { background-color: rgba(var(--bg-card-rgb), 0.95); backdrop-filter: blur(15px) saturate(180%); padding: 25px 30px; border-radius: 20px; box-shadow: 0 0 30px rgba(var(--glow-color-blue-rgb),0.25), 0 10px 40px rgba(0,0,0,0.35); width: 90%; max-width: 500px; border: 1px solid rgba(var(--text-primary),0.15); animation: popInModal 0.3s ease-out; z-index: 2010; }
        @keyframes popInModal { from { opacity:0; transform: scale(0.9) translateY(10px); } to { opacity:1; transform: scale(1) translateY(0); } }
        .modal-content h3 { color: var(--accent-blue-info); margin-top: 0; margin-bottom: 20px; text-align: center; font-size: 1.5em; text-shadow: 0 0 5px rgba(var(--glow-color-blue-rgb), 0.3); }
        .modal-form-group { margin-bottom: 18px; }
        .modal-form-group label { display: block; color: var(--text-secondary); margin-bottom: 6px; font-size: 0.9em; text-align: left; }
        .modal-form-group input[type="text"], .modal-form-group input[type="date"], .modal-form-group input[type="time"], .modal-form-group select { width: 100%; padding: 10px 12px; border: 1px solid #4a505e; border-radius: 8px; background-color: var(--bg-dark); color: var(--text-primary); font-size: 1em; font-family: 'Rubik', sans-serif; }
        .modal-form-group input[type="checkbox"]{ width: auto; vertical-align: middle; margin-left: 5px;}
        .modal-form-group input[type="text"]:focus, .modal-form-group input[type="date"]:focus, .modal-form-group input[type="time"]:focus, .modal-form-group select:focus { outline: none; border-color: var(--accent-blue-info); box-shadow: 0 0 8px rgba(var(--glow-color-blue-rgb), 0.3); }
        .modal-actions { margin-top: 25px; display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; } 
        .modal-actions button { flex-grow: 1; min-width: 100px; padding: 10px 15px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 0.95em; }
        #saveEventBtn { background-color: var(--accent-green-medium); color: var(--bg-dark); } #saveEventBtn:hover { background-color: var(--accent-green-neon); }
        #cancelEventBtn { background-color: var(--bg-card-light); color: var(--text-primary); } #cancelEventBtn:hover { background-color: #3e4450; }
        #deleteEventBtn { background-color: var(--accent-red-clear); color: var(--text-primary); display: none; } #deleteEventBtn:hover { background-color: #d43f3f; }
        .hidden-field { display: none !important; }


        @media (min-width: 1024px) { }
        @media (max-width:768px){  
            .main-navigation { padding: 10px; gap: 8px; top:10px; } 
            .nav-button { padding: 8px 12px; font-size: 0.85em;} 
            .widget-card { padding:20px; margin: 0 auto 20px auto; flex-basis: 100% !important; max-width: calc(100% - 20px) !important;} 
            #ingresos-page .money-display{grid-template-columns:1fr}  
            #ingresos-page .title, .placeholder-page h2, .university-timetable-widget h2, #calendario-page h2 {font-size:1.5em} 
            #timetableGrid { font-size: 0.9em; gap: 2px; padding:10px; grid-template-columns: [times] 45px repeat(5, 1fr); grid-auto-rows: minmax(35px, auto); }
            .timetable-grid-event { font-size: 0.75em; padding: 5px; }
            .timetable-grid-time-label { font-size: 0.75em; padding-right: 5px;}
            .timetable-grid-header { padding: 8px 3px; }
            .fc .fc-toolbar { flex-direction: column; gap: 5px;}
            #calendar-progress-bars .progress-bar-bg-cal { max-width: 100%; } 
        }
        @media (max-width:480px){ 
            body { padding: 10px; } 
            .floating-emoji { font-size: 3.5rem; opacity: 0.1; }  
            .widget-card, .modal-content { backdrop-filter: blur(8px) saturate(120%); -webkit-backdrop-filter: blur(8px) saturate(120%); } 
            #timetableGrid { font-size: 0.8em; grid-template-columns: [times] 40px repeat(5, 1fr); grid-auto-rows: minmax(30px, auto); padding: 5px; }
            .timetable-grid-event { font-size: 0.7em; padding: 4px; min-height: 28px;}
            .timetable-grid-event .subject-name { margin-bottom: 1px; }
            .timetable-grid-time-label { font-size: 0.7em; }
            .fc .fc-toolbar-left, .fc .fc-toolbar-center, .fc .fc-toolbar-right { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 5px; }
            .fc .fc-button { padding: 0.3em 0.5em; font-size: 0.85em;}
            #calendar-progress-bars div {font-size: 0.8em;}
        }
    </style>
</head>
<body>
    <div class="floating-emoji-container">
        <div class="floating-emoji">💰</div> <div class="floating-emoji">💸</div> 
        <div class="floating-emoji">📈</div> <div class="floating-emoji">🎯</div> 
        <div class="floating-emoji">✨</div> <div class="floating-emoji">🚀</div>
        <div class="floating-emoji">💡</div> <div class="floating-emoji">📚</div>
        <div class="floating-emoji">🎉</div> <div class="floating-emoji">💻</div>
    </div>

    <div class="main-container">
        <div class="main-navigation"> 
            <button class="nav-button" data-page="calendario-page">📅 Calendario</button> 
            <button class="nav-button" data-page="ingresos-page">💰 Ingresos</button> 
            <button class="nav-button" data-page="universidad-page">🎓 Universidad</button> 
        </div>

        <div id="ingresos-page" class="page-content">
            <div class="page-widget-container">
                <div id="ingresos-widget-main" class="widget-card"> 
                    <div class="current-month-display glass-section" id="currentMonthDisplay"></div>
                    <div class="title-container"> <h1 class="title">🎯 Meta Ingresos</h1> <div class="target-input-group"> <label for="overallTargetInput">Meta (COP):</label> <input type="number" id="overallTargetInput" step="1000" placeholder="3,500,000"> </div> </div>
                    <p class="subtitle" id="subtitleText">🚀 Progreso hacia tu meta general...</p>
                    <div class="input-section glass-section"> <div class="currency-selector-container"> <label for="currencySelectorIngresos">Moneda de Ingreso:</label> <select id="currencySelectorIngresos"> <option value="USD" selected>USD ($)</option> <option value="COP">COP ($)</option> </select> </div> <input type="number" class="money-input" id="moneyInputIngresos" placeholder="💵 Ingresa cantidad en USD..." min="0.01" step="0.01"> <button class="add-btn" id="addMoneyBtnIngresos">➕ Añadir Ingreso</button> </div>
                    <div class="progress-container"> <div class="progress-bar-bg"> <div class="progress-bar" id="progressBarOverall"></div> </div> <div class="progress-text" id="progressTextOverall">0% 📊</div> </div> <div class="progress-container monthly"> <div class="progress-bar-bg"> <div class="progress-bar monthly-bar" id="progressBarMonthly"></div> </div> <div class="progress-text monthly-text" id="progressTextMonthly">🗓️ Tiempo del Mes: 0%</div> </div> <div class="money-display"> <div class="money-card widget-card"> <div class="money-label">💚 Total Ingresos Netos Acumulados (COP)</div> <div class="money-value" id="totalAccumulatedCOP">$0</div> </div> <div class="money-card widget-card"> <div class="money-label">🏁 Meta General Actual (COP)</div> <div class="money-value" id="overallTargetCOPDisplay">$0</div> </div> <div class="money-card widget-card"> <div class="money-label">📈 Restante Meta General (COP)</div> <div class="money-value" id="overallRemainingCOP">$0</div> </div> <div class="money-card widget-card"> <div class="money-label">💵 Ingresos Netos este Mes (USD)</div> <div class="money-value" id="currentMonthUSDTotal">$0.00</div> </div> </div> <div class="money-card widget-card" style="margin-top: 15px;"> <div class="money-label">🌍 Total Ingresos Netos Histórico (USD)</div> <div class="money-value" id="overallUSDTotal">$0.00</div> <div class="exchange-rate-info" id="exchangeRateInfo" style="margin-top: 5px;">Tasa actual: Cargando...</div> <div class="exchange-rate-source" id="exchangeRateSource" style="display: none;"></div> </div> <div class="celebration-overall" id="celebrationOverall"> 🎉✨ ¡FELICITACIONES! ¡META GENERAL ALCANZADA! ✨🎉<br> 🏆 ¡Eres un maestro del joseo! Te amo. 🏆 </div> 
                    <div class="history widget-card"> <div class="history-title">📝 Historial Detallado de Ingresos (Netos)</div> <div class="history-list" id="historyList"></div> </div> 
                    <div class="monthly-goals-section widget-card"> <div class="monthly-goals-title">🎯 Progreso Ingresos Mensuales (Netos vs Meta)</div> <div class="monthly-goals-list" id="monthlyGoalsList"></div> <button class="clear-btn" id="clearHistoryBtnIngresos">🗑️ Limpiar Todo el Historial</button> </div>
                </div>
            </div>
        </div>

        <div id="calendario-page" class="page-content active">
             <div class="page-widget-container" id="calendar-widget-container">
                <div id="calendar-widget-card" class="widget-card"> 
                    <h2>📅 Calendario Interactivo</h2>
                    <div id="calendar-progress-bars">
                        <div class="progress-item">
                            <span class="progress-label">Mes:</span>
                            <div class="progress-bar-bg-cal"> <div class="progress-bar-cal" id="month-progress-bar-cal"></div> </div>
                            <span class="progress-text-cal" id="month-text-cal">0%</span>
                        </div>
                        <div class="progress-item">
                            <span class="progress-label">Día:</span>
                            <div class="progress-bar-bg-cal"> <div class="progress-bar-cal" id="day-progress-bar-cal"></div> </div>
                            <span class="progress-text-cal" id="day-text-cal">0%</span>
                        </div>
                        <div class="progress-item">
                            <span class="progress-label">Año:</span>
                            <div class="progress-bar-bg-cal"> <div class="progress-bar-cal" id="year-progress-bar-cal"></div> </div>
                            <span class="progress-text-cal" id="year-text-cal">0%</span>
                        </div>
                    </div>
                    <button id="addCalendarEventBtn">➕ Nueva Actividad</button>
                    <div id="mainCalendar"></div>
                    <div id="today-tasks" style="margin-top: 20px; text-align: left; padding:15px; background-color: rgba(var(--bg-card-rgb),0.8); border-radius: 10px;">
                        <h3 style="color: var(--accent-yellow-green); margin-bottom:10px;">📝 Actividades para Hoy:</h3>
                        <ul id="today-tasks-list" style="list-style: none; padding-left: 5px;">
                            <li style="color: var(--text-secondary);">Cargando actividades...</li>
                        </ul>
                    </div>
                </div>
             </div>
        </div>
        
        <div id="universidad-page" class="page-content"> 
             <div class="page-widget-container">
                <div class="university-timetable-widget widget-card"> 
                    <h2>🎓 Horario Universitario</h2>
                    <div id="timetableGrid"> 
                        <!-- El contenido se generará por JavaScript -->
                    </div>
                     <button id="addTimetableEventBtnGlobal" style="margin-top: 20px; padding: 10px 20px; background-color: var(--accent-blue-info); color: var(--bg-dark); border:none; border-radius: 8px; cursor:pointer; font-weight: 600;">➕ Añadir Nuevo Evento</button>
                </div>
            </div>
        </div>
    </div> 

    <div class="modal-overlay" id="eventModalOverlay">
        <div class="modal-content"> 
            <h3 id="eventModalTitle">Añadir/Editar Evento</h3>
            <form id="eventForm">
                <input type="hidden" id="eventModalId"> 
                <input type="hidden" id="eventModalType"> 

                <div class="modal-form-group"> <label for="eventTitle">Título/Materia:</label> <input type="text" id="eventTitle" required> </div>
                
                <div id="modalTimetableFields">
                    <div class="modal-form-group"> <label for="eventTeacher">Profesor:</label> <input type="text" id="eventTeacher"> </div>
                    <div class="modal-form-group"> <label for="eventDay">Día (Horario):</label> <select id="eventDay"></select> </div>
                    <div class="modal-form-group timetable-common-fields"> <label for="eventStartTime">Hora Inicio (Horario):</label> <select id="eventStartTime"></select> </div>
                    <div class="modal-form-group timetable-common-fields"> <label for="eventEndTime">Hora Fin (Horario):</label> <select id="eventEndTime"></select> </div>
                </div>

                 <div id="modalCalendarFields">
                    <div class="modal-form-group"> <label for="eventStartDate">Fecha:</label> <input type="date" id="eventStartDate" required> </div>
                    <div class="modal-form-group hidden-field"> <label for="eventStartTimeCal">Hora Inicio (Calendario):</label> <input type="time" id="eventStartTimeCal"> </div>
                    <div class="modal-form-group hidden-field"> <label for="eventEndDate">Fecha Fin:</label> <input type="date" id="eventEndDate"> </div>
                    <div class="modal-form-group hidden-field"> <label for="eventEndTimeCal">Hora Fin (Calendario):</label> <input type="time" id="eventEndTimeCal"> </div>
                    <div class="modal-form-group hidden-field"><label for="eventAllDay">Todo el día:</label><input type="checkbox" id="eventAllDay" checked></div>
                </div>
                
                <div class="modal-form-group"> 
                    <label for="eventColorSelect">Color del Evento:</label> 
                    <select id="eventColorSelect" required></select>
                </div>
                <div class="modal-actions"> 
                    <button type="button" id="deleteEventBtn">Eliminar</button> 
                    <button type="button" id="cancelEventBtn">Cancelar</button> 
                    <button type="submit" id="saveEventBtn">Guardar</button> 
                </div>
            </form>
        </div>
    </div>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/ical.js@2.0.1/build/ical.min.js'></script>

    <!-- Firebase SDK -->
    <!-- TU SDK de Firebase (asegúrate que sean las versiones que usas y que sean compatibles) -->
    <!-- Using the compat libraries for easier transition from v8 to v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- Si necesitas autenticación en el futuro: -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script> -->


    <script>
        // --- FIREBASE CONFIG ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBCuJ4Xetzex0zQpnrOKx1bLihpfX-0KaI", // REEMPLAZA ESTA CON TU API KEY REAL DE FIREBASE
            authDomain: "meta-ingresos-app.firebaseapp.com",
            projectId: "meta-ingresos-app",
            storageBucket: "meta-ingresos-app.firebasestorage.app",
            messagingSenderId: "367840381632",
            appId: "1:367840381632:web:8d124fc5ee24183445fb25",
            measurementId: "G-SE63KFXXRS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ------ IMPORTANTE: USER ID PLACEHOLDER ------
        // En una aplicación real, obtendrías el userId del usuario autenticado.
        // Por ahora, usaremos un ID fijo para que todos los datos se guarden/lean del mismo sitio.
        // Esto NO es seguro para múltiples usuarios. Deberías implementar Firebase Authentication.
        const userId = 'mainUserData'; 
        // -------------------------------------------

        // --- CONFIGURACIONES GLOBALES ---
        const DEFAULT_OVERALL_TARGET_COP = 3500000; 
        // const LOCAL_STORAGE_KEY_INGRESOS = 'financialGoal_v27_monthlyTarget'; // No más para datos principales
        // const LAST_RUN_MONTH_KEY_INGRESOS = LOCAL_STORAGE_KEY_INGRESOS + '_lastRunMonth'; // Se manejará en Firebase
        const EXCHANGE_RATE_API_URL_ERAPI = 'https://open.er-api.com/v6/latest/USD'; 
        const RATE_CACHE_DURATION = 3 * 60 * 60 * 1000; // 3 horas para caché de tasa de cambio
        const RATE_CACHE_KEY_INGRESOS = 'exchangeRateCache_erapi'; // Clave para localStorage de tasa
        const FALLBACK_RATE = 4000; 
        const FIXED_FEE_USD = 3; 
        const PERCENTAGE_FEE = 0.03; 
        const MIN_USD_INPUT_FOR_NET_CALC = FIXED_FEE_USD + 0.01; 
        
        const TIMETABLE_START_HOUR = 5; 
        const TIMETABLE_END_HOUR = 23;  
        const TIMETABLE_DAYS = ["LUNES", "MARTES", "MIÉRCOLES", "JUEVES", "VIERNES"];
        // const LOCAL_STORAGE_KEY_TIMETABLE = 'universityTimetable_v7_grid_pastelColors'; // No más
        
        const PRESET_PASTEL_COLORS = [
            { name: "Rosa Suave", value: "#FFB6C1" }, { name: "Melocotón", value: "#FFDAB9" },
            { name: "Amarillo Claro", value: "#FFFFE0" }, { name: "Menta", value: "#98FB98" },
            { name: "Cielo", value: "#ADD8E6" }, { name: "Lavanda", value: "#E6E6FA" },
            { name: "Gris Perla", value: "#D3D3D3" }, { name: "Beige Arenoso", value: "#F5F5DC" },
            { name: "Verde Mar", value: "#AFEEEE" },   
            { name: "Salmón Claro", value: "#FFA07A" }
        ];
        const DEFAULT_EVENT_COLOR = PRESET_PASTEL_COLORS[0].value; 

        // const LOCAL_STORAGE_KEY_CALENDAR_EVENTS = 'mainCalendarEvents_v4_dateFix'; // No más
        let calendarEventsData = []; 
        let mainCalendarInstance = null; 
        
        // Variables de estado de la aplicación (se cargarán desde Firebase)
        let contributions = []; 
        let currentDailyExchangeRate = null; 
        let selectedInputCurrencyIngresos = 'USD'; 
        let monthlyTargets = {}; 
        let currentOverallTargetCOP = DEFAULT_OVERALL_TARGET_COP; 
        let lastRunMonthIngresos = null; // Para la lógica de reinicio mensual

        let timetableData = []; 
        
        let currentEditingEventId = null; 
        let currentEditingEventType = ''; 
        let defaultPage = 'calendario-page'; 
        let dayProgressInterval = null; 
        
        const elIngresos = {  currentMonthDisplay: document.getElementById('currentMonthDisplay'), moneyInput: document.getElementById('moneyInputIngresos'),  addMoneyButton: document.getElementById('addMoneyBtnIngresos'),  clearHistoryButton: document.getElementById('clearHistoryBtnIngresos'), overallTargetInput: document.getElementById('overallTargetInput'), subtitle: document.getElementById('subtitleText'), progressBarOverall: document.getElementById('progressBarOverall'), progressTextOverall: document.getElementById('progressTextOverall'), progressBarMonthly: document.getElementById('progressBarMonthly'), progressTextMonthly: document.getElementById('progressTextMonthly'), totalAccumulatedCOP: document.getElementById('totalAccumulatedCOP'),  overallTargetCOPDisplay: document.getElementById('overallTargetCOPDisplay'),  overallRemainingCOP: document.getElementById('overallRemainingCOP'),  currentMonthUSDTotal: document.getElementById('currentMonthUSDTotal'), overallUSDTotal: document.getElementById('overallUSDTotal'),  exchangeRateInfo: document.getElementById('exchangeRateInfo'), exchangeRateSource: document.getElementById('exchangeRateSource'), celebrationOverall: document.getElementById('celebrationOverall'),  historyList: document.getElementById('historyList'), monthlyGoalsList: document.getElementById('monthlyGoalsList'), currencySelector: document.getElementById('currencySelectorIngresos')  };
        const addTimetableEventBtnGlobal = document.getElementById('addTimetableEventBtnGlobal'); 
        const addCalendarEventBtn = document.getElementById('addCalendarEventBtn');
        
        const eventModalOverlay = document.getElementById('eventModalOverlay');
        const eventForm = document.getElementById('eventForm');
        const eventModalTitle = document.getElementById('eventModalTitle');
        const modalEventIdInput = document.getElementById('eventModalId'); 
        const modalEventTypeInput = document.getElementById('eventModalType');
        const modalEventTitleInput = document.getElementById('eventTitle'); 
        const modalTimetableFields = document.getElementById('modalTimetableFields');
        const modalEventTeacherInput = document.getElementById('eventTeacher');
        const modalEventDaySelect = document.getElementById('eventDay');
        const modalCalendarFields = document.getElementById('modalCalendarFields');
        const modalEventStartDateInput = document.getElementById('eventStartDate');
        const modalEventStartTimeCalInput = document.getElementById('eventStartTimeCal');
        const modalEventEndDateInput = document.getElementById('eventEndDate');
        const modalEventEndTimeCalInput = document.getElementById('eventEndTimeCal');
        const modalEventAllDayCheckbox = document.getElementById('eventAllDay');
        const modalEventStartTimeSelect = document.getElementById('eventStartTime'); 
        const modalEventEndTimeSelect = document.getElementById('eventEndTime');   
        const modalEventColorSelect = document.getElementById('eventColorSelect');
        const saveEventBtn = document.getElementById('saveEventBtn');
        const cancelEventBtn = document.getElementById('cancelEventBtn');
        const deleteEventBtn = document.getElementById('deleteEventBtn');

        function showPage(pageId) { 
            const navButtons = document.querySelectorAll('.nav-button');
            const pageContents = document.querySelectorAll('.page-content');
            pageContents.forEach(page => { page.classList.remove('active'); }); 
            navButtons.forEach(button => { button.classList.remove('active'); if (button.dataset.page === pageId) { button.classList.add('active'); } }); 
            const activePage = document.getElementById(pageId); 
            if (activePage) { 
                activePage.classList.add('active'); 
                if (pageId === 'calendario-page') {
                    if (!mainCalendarInstance) {
                        initializeMainCalendar(); 
                    } else {
                         updateCalendarProgressBars(); 
                         updateTodayTasksList();
                         mainCalendarInstance.updateSize(); 
                    }
                    if (!dayProgressInterval) { 
                        updateCalendarDayProgressBar(); 
                        dayProgressInterval = setInterval(updateCalendarDayProgressBar, 30000); 
                    }
                } else {
                    if (dayProgressInterval) { 
                        clearInterval(dayProgressInterval);
                        dayProgressInterval = null;
                    }
                }
            } 
        }
        document.querySelectorAll('.nav-button').forEach(button => { button.addEventListener('click', () => { showPage(button.dataset.page); }); });

        // --- FUNCIONES DE INGRESOS ---
        function formatUSD(amount) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount); } function formatCOP(amount) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount); }  
        
        async function fetchAndUpdateDailyExchangeRateWithERAPI_Ingresos() { 
            if(!elIngresos.exchangeRateInfo || !elIngresos.addMoneyButton) return; 
            elIngresos.exchangeRateInfo.textContent = "Tasa actual: Actualizando..."; 
            elIngresos.exchangeRateSource.style.display = 'none'; 
            elIngresos.addMoneyButton.disabled = true; 
            elIngresos.addMoneyButton.innerHTML = `🔄 Cargando Tasa...`; 
            let success = false; 
            try { 
                const response = await fetch(EXCHANGE_RATE_API_URL_ERAPI); 
                if (!response.ok) { const errorText = await response.text(); throw new Error(`Error HTTP ${response.status}: ${response.statusText}. Cuerpo: ${errorText}`); } 
                const data = await response.json(); 
                if (data && data.rates && typeof data.rates.COP === 'number') { 
                    currentDailyExchangeRate = data.rates.COP; 
                    localStorage.setItem(RATE_CACHE_KEY_INGRESOS, JSON.stringify({ rate: currentDailyExchangeRate, timestamp: Date.now(), dateFetched: new Date(data.time_last_update_unix * 1000).toLocaleDateString('es-CO') })); 
                    elIngresos.exchangeRateInfo.textContent = `1 USD = ${currentDailyExchangeRate.toFixed(4)} COP`; 
                    success = true; 
                } else { 
                    throw new Error("Formato API (ER-API) inesperado."); 
                } 
            } catch (error) { 
                console.error("FALLO al obtener tasa de ER-API:", error); 
                currentDailyExchangeRate = null; 
            } 
            if (!success && currentDailyExchangeRate === null) { 
                const cachedData = localStorage.getItem(RATE_CACHE_KEY_INGRESOS); 
                const cached = cachedData ? JSON.parse(cachedData) : null; 
                if (cached && typeof cached.rate === 'number' && (Date.now() - cached.timestamp < RATE_CACHE_DURATION * 24 )) { // Extend cache use if API fails
                    currentDailyExchangeRate = cached.rate; 
                    elIngresos.exchangeRateInfo.textContent = `1 USD = ${currentDailyExchangeRate.toFixed(4)} COP (Cache)`; 
                    success = true; 
                } 
            } 
            if (currentDailyExchangeRate === null || isNaN(currentDailyExchangeRate)) { 
                currentDailyExchangeRate = FALLBACK_RATE; 
                elIngresos.exchangeRateInfo.textContent = `1 USD ≈ ${currentDailyExchangeRate.toFixed(2)} COP (Respaldo)`; 
            } 
            elIngresos.addMoneyButton.disabled = false; 
            elIngresos.addMoneyButton.innerHTML = `➕ Añadir Ingreso`; 
            updateInputPlaceholder_Ingresos(); 
            return currentDailyExchangeRate; 
        }  
        
        async function getDailyExchangeRate_Ingresos() { 
            const cachedData = localStorage.getItem(RATE_CACHE_KEY_INGRESOS); 
            const cached = cachedData ? JSON.parse(cachedData) : null; 
            if (cached && typeof cached.rate === 'number' && !isNaN(cached.rate) && (Date.now() - cached.timestamp < RATE_CACHE_DURATION)) { 
                currentDailyExchangeRate = cached.rate; 
                if(elIngresos.exchangeRateInfo) elIngresos.exchangeRateInfo.textContent = `1 USD = ${currentDailyExchangeRate.toFixed(4)} COP (Cache)`; 
                updateInputPlaceholder_Ingresos(); 
                return currentDailyExchangeRate; 
            } 
            return await fetchAndUpdateDailyExchangeRateWithERAPI_Ingresos(); 
        }  
        
        async function loadData_Ingresos() {
            console.log("Intentando cargar datos de ingresos desde Firebase...");
            try {
                const docRef = db.collection('users').doc(userId);
                const docSnap = await docRef.get();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const ingresosData = data.ingresos || {}; // Get the 'ingresos' field

                    contributions = Array.isArray(ingresosData.contributions) ? ingresosData.contributions.map(c => ({ 
                        ...c, 
                        amountUSD: parseFloat(c.amountUSD) || 0, 
                        amountCOP: parseFloat(c.amountCOP) || 0, 
                        originalAmountUSD: parseFloat(c.originalAmountUSD) || 0, 
                        exchangeRate: parseFloat(c.exchangeRate) || 0,
                    })) : [];
                    selectedInputCurrencyIngresos = ingresosData.selectedInputCurrencyIngresos || 'USD';
                    if(elIngresos.currencySelector) elIngresos.currencySelector.value = selectedInputCurrencyIngresos;
                    
                    monthlyTargets = ingresosData.monthlyTargets || {};
                    lastRunMonthIngresos = ingresosData.lastRunMonth || null;

                    const currentMonthKey = getCurrentMonthYear_Ingresos();
                    currentOverallTargetCOP = monthlyTargets[currentMonthKey] || ingresosData.currentOverallTargetCOP || DEFAULT_OVERALL_TARGET_COP;
                    
                    if(elIngresos.overallTargetInput) elIngresos.overallTargetInput.value = currentOverallTargetCOP;
                    console.log("Datos de ingresos cargados desde Firebase.", ingresosData);
                } else {
                    console.log("No se encontraron datos de ingresos en Firebase para el usuario. Inicializando con valores por defecto.");
                    // Initialize with defaults if no document exists
                    contributions = [];
                    selectedInputCurrencyIngresos = 'USD';
                    if(elIngresos.currencySelector) elIngresos.currencySelector.value = selectedInputCurrencyIngresos;
                    monthlyTargets = {};
                    const currentMonthKey = getCurrentMonthYear_Ingresos();
                    currentOverallTargetCOP = DEFAULT_OVERALL_TARGET_COP;
                    monthlyTargets[currentMonthKey] = currentOverallTargetCOP; // Set initial target for current month
                    if(elIngresos.overallTargetInput) elIngresos.overallTargetInput.value = currentOverallTargetCOP;
                    lastRunMonthIngresos = null; // No previous run
                    
                    // Save these defaults to Firebase
                    await saveData_Ingresos(); 
                }
            } catch (error) {
                console.error("Error cargando datos de ingresos desde Firebase:", error);
                // Fallback to local defaults in case of error, but don't rely on localStorage for persistence
                contributions = [];
                selectedInputCurrencyIngresos = 'USD';
                monthlyTargets = {};
                currentOverallTargetCOP = DEFAULT_OVERALL_TARGET_COP;
                if(elIngresos.overallTargetInput) elIngresos.overallTargetInput.value = currentOverallTargetCOP;
                lastRunMonthIngresos = null;
                alert("Error al cargar datos de ingresos. Se usarán valores por defecto. Revisa la consola.");
            }
        }
          
        async function saveData_Ingresos() {
            try {
                const currentMonthKey = getCurrentMonthYear_Ingresos();
                monthlyTargets[currentMonthKey] = currentOverallTargetCOP; // Ensure current target is saved for the month

                const ingresosDataToSave = {
                    contributions,
                    selectedInputCurrencyIngresos,
                    monthlyTargets,
                    currentOverallTargetCOP, // Save the current overall target as well
                    lastRunMonth: lastRunMonthIngresos // Save the last run month for reset logic
                };

                // Using .set with { merge: true } to update or create the 'ingresos' field
                // within the user's document without overwriting other fields like 'timetable' or 'calendarEvents'.
                await db.collection('users').doc(userId).set({
                    ingresos: ingresosDataToSave 
                }, { merge: true });
                console.log("Datos de ingresos guardados en Firebase.");
            } catch (e) {
                console.error("Error guardando datos de ingresos en Firebase:", e);
                alert("Error al guardar datos de ingresos en la nube. Revisa la consola.");
            }
        }
          
        function getCurrentMonthYear_Ingresos() { const now = new Date(); return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; }  
        
        function updateInputPlaceholder_Ingresos() { 
            if(!elIngresos.moneyInput) return; 
            if (selectedInputCurrencyIngresos === 'USD') { 
                elIngresos.moneyInput.placeholder = '💵 Ingresa cantidad BRUTA en USD...'; 
                elIngresos.moneyInput.min = MIN_USD_INPUT_FOR_NET_CALC; 
            } else { 
                elIngresos.moneyInput.placeholder = '💰 Ingresa cantidad en COP...'; 
                elIngresos.moneyInput.min = "0.01"; 
                if (currentDailyExchangeRate === null || isNaN(currentDailyExchangeRate)) { 
                    elIngresos.moneyInput.placeholder = '💰 (Tasa COP no disponible)'; 
                } 
            } 
        }  
        
        async function addMoney_Ingresos() { 
            if(!elIngresos.moneyInput) return; 
            const rawAmount = parseFloat(elIngresos.moneyInput.value); 
            if (isNaN(rawAmount) || rawAmount <= 0) { alert(`⚠️ Ingrese un monto válido.`); return; } 
            let netAmountUSD, netAmountCOP; 
            let originalGrossAmountUSD = 0; 
            if (currentDailyExchangeRate === null || isNaN(currentDailyExchangeRate)) { 
                await getDailyExchangeRate_Ingresos(); 
                if(currentDailyExchangeRate === null || isNaN(currentDailyExchangeRate) || currentDailyExchangeRate === FALLBACK_RATE) { 
                    if (currentDailyExchangeRate === FALLBACK_RATE && !confirm(`No se pudo obtener la tasa actual. ¿Desea continuar usando una tasa de respaldo de 1 USD = ${FALLBACK_RATE} COP?`)) { 
                        return; 
                    } else if (currentDailyExchangeRate === null || isNaN(currentDailyExchangeRate)) { 
                        alert('⏳ Tasa de cambio aún no disponible. No se puede añadir el ingreso.'); 
                        return; 
                    } 
                } 
            } 
            if (selectedInputCurrencyIngresos === 'USD') { 
                originalGrossAmountUSD = rawAmount; 
                if (originalGrossAmountUSD < MIN_USD_INPUT_FOR_NET_CALC) { 
                    alert(`⚠️ El monto bruto en USD debe ser al menos ${formatUSD(MIN_USD_INPUT_FOR_NET_CALC)} para cubrir la comisión fija de ${formatUSD(FIXED_FEE_USD)} y generar un valor neto positivo.`); 
                    return; 
                } 
                const amountAfterFixedFee = originalGrossAmountUSD - FIXED_FEE_USD; 
                netAmountUSD = amountAfterFixedFee * (1 - PERCENTAGE_FEE); 
                if (netAmountUSD <= 0) { 
                    alert(`⚠️ Después de las comisiones (fija: ${formatUSD(FIXED_FEE_USD)}, porcentual: ${PERCENTAGE_FEE*100}%), el monto neto en USD es ${formatUSD(netAmountUSD)} o menos. No se añadirá ningún ingreso.`); 
                    elIngresos.moneyInput.value = ''; 
                    return; 
                } 
                netAmountCOP = netAmountUSD * currentDailyExchangeRate; 
            } else { 
                netAmountCOP = rawAmount; 
                if (currentDailyExchangeRate === 0 || currentDailyExchangeRate === null || isNaN(currentDailyExchangeRate)) { 
                    alert('Error: Tasa de cambio no disponible o es cero. No se puede convertir COP a USD.'); 
                    return; 
                } 
                netAmountUSD = netAmountCOP / currentDailyExchangeRate; 
                originalGrossAmountUSD = netAmountUSD; 
            } 
            const now = new Date(); 
            contributions.push({ 
                amountUSD: netAmountUSD, 
                amountCOP: netAmountCOP, 
                originalAmountUSD: originalGrossAmountUSD, 
                exchangeRate: currentDailyExchangeRate, 
                date: now.toLocaleDateString('es-CO'), 
                time: now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }), 
                monthYear: getCurrentMonthYear_Ingresos() 
            }); 
            if (selectedInputCurrencyIngresos === 'USD') { 
                const feedbackMsg = `Monto Bruto Ingresado: ${formatUSD(originalGrossAmountUSD)}\n` + `Comisión Fija Deducida: ${formatUSD(FIXED_FEE_USD)}\n`+ `Subtotal después de Fija: ${formatUSD(originalGrossAmountUSD - FIXED_FEE_USD)}\n`+ `Comisión Porcentual (${PERCENTAGE_FEE*100}%) Deducida: ${formatUSD((originalGrossAmountUSD - FIXED_FEE_USD) * PERCENTAGE_FEE)}\n`+ `Monto Neto USD Registrado: ${formatUSD(netAmountUSD)}\n`+ `Equivalente en COP Registrado: ${formatCOP(netAmountCOP)}`; 
                console.log("Detalle del ingreso añadido (USD Bruto -> Neto):\n" + feedbackMsg); 
            } 
            elIngresos.moneyInput.value = ''; 
            updateAllDisplays_Ingresos(); 
            await saveData_Ingresos(); 
        }  
        
        function getTotalUSDSavedOverall_Ingresos() { return contributions.reduce((s, c) => s + c.amountUSD, 0); }  
        function getTotalCOPSavedOverall_Ingresos() { return contributions.reduce((s,c) => s + c.amountCOP, 0); }  
        function getTotalUSDSavedThisMonth_Ingresos() { 
            const currentMonth = getCurrentMonthYear_Ingresos(); 
            return contributions 
                .filter(c => c.monthYear === currentMonth) 
                .reduce((sum, contrib) => sum + contrib.amountUSD, 0); 
        }  
        
        function getProgressBarColor_Ingresos(percentage, type = 'general') { 
            const rootStyles = getComputedStyle(document.documentElement); 
            if (type === 'general') { 
                if (percentage >= 100) return 'var(--celebration-overall-bg)'; 
                // Estas variables CSS (--quartileX-color-general) no están definidas en el CSS original.
                // Usaré los colores de progreso del calendario como referencia o colores fijos.
                if (percentage < 25) return 'var(--cal-progress-q1)'; // Antes: rootStyles.getPropertyValue('--quartile1-color-general').trim();
                if (percentage < 50) return 'var(--cal-progress-q2)'; // Antes: rootStyles.getPropertyValue('--quartile2-color-general').trim();
                if (percentage < 75) return 'var(--cal-progress-q3)'; // Antes: rootStyles.getPropertyValue('--quartile3-color-general').trim();
                return 'var(--cal-progress-q4)'; // Antes: rootStyles.getPropertyValue('--quartile4-color-general').trim();
            } else { 
                return rootStyles.getPropertyValue('--monthly-time-progress-color').trim(); 
            } 
        }  
        
        function updateDisplay_Ingresos() { 
            if(!elIngresos.subtitle) return; 
            const totalCOPSavedOverall = getTotalCOPSavedOverall_Ingresos(); 
            const totalUSDSavedOverall = getTotalUSDSavedOverall_Ingresos(); 
            const totalUSDSavedThisMonth = getTotalUSDSavedThisMonth_Ingresos(); 
            const percentageOverall = currentOverallTargetCOP > 0 ? Math.min((totalCOPSavedOverall / currentOverallTargetCOP) * 100, 100) : 0; 
            const remainingOverallCOP = Math.max(currentOverallTargetCOP - totalCOPSavedOverall, 0); 
            elIngresos.subtitle.textContent = `🚀 Progreso hacia tu meta de ${formatCOP(currentOverallTargetCOP)}`; 
            const overallBarColor = getProgressBarColor_Ingresos(percentageOverall, 'general'); 
            elIngresos.progressBarOverall.style.width = percentageOverall + '%'; 
            elIngresos.progressBarOverall.style.background = overallBarColor; 
            if (percentageOverall > 0) { 
                let glowColorOverall = overallBarColor === 'var(--celebration-overall-bg)' ? getComputedStyle(document.documentElement).getPropertyValue('--celebration-overall-glow').trim() : overallBarColor; 
                if (overallBarColor.startsWith('linear-gradient')) { 
                    glowColorOverall = getComputedStyle(document.documentElement).getPropertyValue('--accent-green-neon').trim(); 
                } 
                elIngresos.progressBarOverall.style.boxShadow = ` 0 0 8px 2px ${glowColorOverall}, 0 0 15px 4px ${glowColorOverall} `; 
            } else { 
                elIngresos.progressBarOverall.style.boxShadow = 'none'; 
            } 
            elIngresos.progressTextOverall.textContent = percentageOverall.toFixed(1) + '% 📊'; 
            elIngresos.totalAccumulatedCOP.textContent = formatCOP(totalCOPSavedOverall); 
            elIngresos.overallTargetCOPDisplay.textContent = formatCOP(currentOverallTargetCOP); 
            elIngresos.overallRemainingCOP.textContent = formatCOP(remainingOverallCOP); 
            elIngresos.currentMonthUSDTotal.textContent = formatUSD(totalUSDSavedThisMonth); 
            elIngresos.overallUSDTotal.textContent = formatUSD(totalUSDSavedOverall); 
            elIngresos.celebrationOverall.style.display = (totalCOPSavedOverall >= currentOverallTargetCOP && currentOverallTargetCOP > 0 && contributions.length > 0) ? 'block' : 'none'; 
            const today = new Date(); 
            const currentDayOfMonth = today.getDate(); 
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate(); 
            const percentageTimeOfMonth = Math.min((currentDayOfMonth / daysInMonth) * 100, 100); 
            const monthlyBarColor = getProgressBarColor_Ingresos(percentageTimeOfMonth, 'monthly_time'); 
            elIngresos.progressBarMonthly.style.width = percentageTimeOfMonth + '%'; 
            elIngresos.progressBarMonthly.style.background = monthlyBarColor; 
            if (percentageTimeOfMonth > 0) { 
                elIngresos.progressBarMonthly.style.boxShadow = ` 0 0 8px 2px ${monthlyBarColor}, 0 0 15px 4px ${monthlyBarColor} `; 
            } else { 
                elIngresos.progressBarMonthly.style.boxShadow = 'none'; 
            } 
            elIngresos.progressTextMonthly.textContent = `🗓️ Tiempo del Mes: ${percentageTimeOfMonth.toFixed(0)}%`;  
        }  
        
        function updateHistory_Ingresos() { 
            if(!elIngresos.historyList) return; 
            if (contributions.length === 0) { 
                elIngresos.historyList.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:20px;">🌱 Sin ingresos aún.</div>'; 
                return; 
            } 
            elIngresos.historyList.innerHTML = ''; 
            contributions.slice().reverse().forEach(c => { 
                const item = document.createElement('div'); 
                item.className = 'history-item'; 
                const rateDisplay = typeof c.exchangeRate === 'number' ? c.exchangeRate.toFixed(4) : 'N/A'; 
                let originalAmountDisplay = ''; 
                if (c.originalAmountUSD && c.originalAmountUSD > 0 && c.originalAmountUSD.toFixed(2) !== c.amountUSD.toFixed(2)) { 
                    originalAmountDisplay = `<span class="history-original-amount">(Bruto: ${formatUSD(c.originalAmountUSD)})</span>`; 
                } 
                item.innerHTML = ` <div> <div class="history-date">📅 ${c.date} - ${c.time} (${c.monthYear})</div> <div class="history-amount" style="font-size:0.9em;"> +${formatUSD(c.amountUSD)} ${originalAmountDisplay} <span class="history-rate">(a ${rateDisplay})</span> </div> </div> <div class="history-amount" style="color:var(--accent-green-medium);">${formatCOP(c.amountCOP)}</div>`; 
                elIngresos.historyList.appendChild(item); 
            }); 
        }  
        
        function updateMonthlyGoalsDisplay_Ingresos() { 
            if(!elIngresos.monthlyGoalsList) return; 
            const savingsByMonth = {}; 
            const currentMonthKey_Ingresos = getCurrentMonthYear_Ingresos(); 
            contributions.forEach(c => { savingsByMonth[c.monthYear] = (savingsByMonth[c.monthYear] || 0) + c.amountCOP; }); 
            elIngresos.monthlyGoalsList.innerHTML = ''; 
            let uniquePastAndCurrentMonths = new Set(); 
            contributions.forEach(c => uniquePastAndCurrentMonths.add(c.monthYear)); 
            uniquePastAndCurrentMonths.add(currentMonthKey_Ingresos); 
            
            if (contributions.length > 0) { 
                const firstContributionMonthYear = contributions.length ? contributions.reduce((oldest, current) => new Date(current.monthYear + '-01') < new Date(oldest.monthYear + '-01') ? current : oldest).monthYear : null; 
                if (firstContributionMonthYear) { 
                    let datePointer = new Date(firstContributionMonthYear + '-01'); 
                    const todayFirstOfMonth = new Date(currentMonthKey_Ingresos + '-01'); 
                    while(datePointer <= todayFirstOfMonth) { 
                        uniquePastAndCurrentMonths.add(`${datePointer.getFullYear()}-${String(datePointer.getMonth() + 1).padStart(2, '0')}`); 
                        datePointer.setMonth(datePointer.getMonth() + 1); 
                    } 
                } 
            } 
            
            if (uniquePastAndCurrentMonths.size === 0 && Object.keys(monthlyTargets).length === 0) { 
                elIngresos.monthlyGoalsList.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:20px;">Aún no hay historial de meses.</div>'; 
                return; 
            } 
            
            Object.keys(monthlyTargets).forEach(m => uniquePastAndCurrentMonths.add(m)); 
            const sortedMonths = Array.from(uniquePastAndCurrentMonths).sort().reverse(); 
            
            sortedMonths.forEach(monthYearKey => { 
                const [year, monthNum] = monthYearKey.split('-'); 
                const monthName = new Date(parseInt(year), parseInt(monthNum) - 1, 1) .toLocaleString('es-CO', { month: 'long', year: 'numeric' }); 
                const monthNameCapitalized = monthName.charAt(0).toUpperCase() + monthName.slice(1); 
                const savedThisMonthCOP = savingsByMonth[monthYearKey] || 0; 
                const targetForThisListEntry = monthlyTargets[monthYearKey] || (monthYearKey === currentMonthKey_Ingresos ? currentOverallTargetCOP : DEFAULT_OVERALL_TARGET_COP); 
                const item = document.createElement('div'); 
                item.className = 'monthly-goal-item'; 
                let statusText, statusClass; 
                if (monthYearKey < currentMonthKey_Ingresos) { 
                    if (savedThisMonthCOP >= targetForThisListEntry && targetForThisListEntry > 0) { 
                        statusText = `✅ ¡Cumplido! (${formatCOP(savedThisMonthCOP)} de ${formatCOP(targetForThisListEntry)})`; 
                        statusClass = 'achieved'; 
                    } else { 
                        statusText = `❌ No Cumplido (${formatCOP(savedThisMonthCOP)} de ${formatCOP(targetForThisListEntry)})`; 
                        statusClass = 'not-achieved'; 
                    } 
                } else { 
                    if (savedThisMonthCOP >= targetForThisListEntry && targetForThisListEntry > 0) { 
                        statusText = `🎉 ¡Superado Meta! (${formatCOP(savedThisMonthCOP)} de ${formatCOP(targetForThisListEntry)})`; 
                        statusClass = 'achieved'; 
                    } else { 
                        statusText = `⏳ En Progreso (${formatCOP(savedThisMonthCOP)} de ${formatCOP(targetForThisListEntry)})`; 
                        statusClass = 'pending'; 
                    } 
                } 
                item.innerHTML = ` <div class="monthly-goal-month">${monthNameCapitalized}</div> <div class="monthly-goal-status ${statusClass}">${statusText}</div>`; 
                elIngresos.monthlyGoalsList.appendChild(item); 
            }); 
        }  
        
        function updateCurrentMonthDisplayDOM_Ingresos() { 
            if(!elIngresos.currentMonthDisplay) return; 
            const now = new Date(); 
            const monthName = now.toLocaleString('es-CO', { month: 'long' }); 
            const year = now.getFullYear(); 
            elIngresos.currentMonthDisplay.textContent = `🗓️ ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} de ${year}`; 
        }  
        
        async function checkForMonthlyResetLogic_Ingresos() { 
            if(!elIngresos.overallTargetInput) return;  
            const currentMonthKey = getCurrentMonthYear_Ingresos(); 
            
            // 'lastRunMonthIngresos' is now loaded from Firebase
            if (currentMonthKey !== lastRunMonthIngresos) { 
                console.log(`Nuevo mes detectado (Ingresos): ${currentMonthKey}. El último mes registrado fue ${lastRunMonthIngresos || 'ninguno'}.`); 
                currentOverallTargetCOP = monthlyTargets[currentMonthKey] || DEFAULT_OVERALL_TARGET_COP; 
                elIngresos.overallTargetInput.value = currentOverallTargetCOP; 
                lastRunMonthIngresos = currentMonthKey; // Update the state variable
                await saveData_Ingresos(); // Save the new lastRunMonth and potentially new target to Firebase
                updateAllDisplays_Ingresos(); 
            }  
        }  
        
        function updateAllDisplays_Ingresos() { 
            updateDisplay_Ingresos(); 
            updateHistory_Ingresos(); 
            updateMonthlyGoalsDisplay_Ingresos(); 
        }  
        
        async function clearHistory_Ingresos() { 
            if(!elIngresos.currencySelector || !elIngresos.overallTargetInput) return;  
            if (confirm('🤔 ¿Limpiar TODO el historial de ingresos, metas y reiniciar el progreso? Esta acción es irreversible y afectará los datos en la nube.')) { 
                contributions = []; 
                selectedInputCurrencyIngresos = 'USD'; 
                elIngresos.currencySelector.value = 'USD'; 
                monthlyTargets = {}; 
                const currentMonthKey = getCurrentMonthYear_Ingresos(); 
                currentOverallTargetCOP = DEFAULT_OVERALL_TARGET_COP; 
                monthlyTargets[currentMonthKey] = currentOverallTargetCOP; 
                elIngresos.overallTargetInput.value = currentOverallTargetCOP; 
                lastRunMonthIngresos = currentMonthKey; // Reset last run month

                await saveData_Ingresos(); // Save cleared data to Firebase
                
                // localStorage.removeItem(LAST_RUN_MONTH_KEY_INGRESOS); // No longer needed
                // localStorage.setItem(LAST_RUN_MONTH_KEY_INGRESOS, currentMonthKey); // No longer needed
                localStorage.removeItem(RATE_CACHE_KEY_INGRESOS); // Clear exchange rate cache
                currentDailyExchangeRate = null;  
                
                updateCurrentMonthDisplayDOM_Ingresos(); 
                getDailyExchangeRate_Ingresos().then(updateAllDisplays_Ingresos); 
            }  
        }

        // --- FUNCIONES DEL HORARIO UNIVERSITARIO ---
        async function loadTimetableData() {
            console.log("Intentando cargar datos del horario desde Firebase...");
            const defaultTimetable = [ 
                { id: 'ev1', day: 'MIÉRCOLES', startTime: '08:00', endTime: '10:00', subject: 'Estrategia', teacher: 'Prof. X', color: PRESET_PASTEL_COLORS[0].value },
                { id: 'ev3', day: 'LUNES', startTime: '14:00', endTime: '16:00', subject: 'Mercadeo', teacher: 'Prof. Luna', color: PRESET_PASTEL_COLORS[1].value },
                { id: 'ev4', day: 'MARTES', startTime: '14:00', endTime: '15:00', subject: 'Negocios Digitales', teacher: 'Prof. Sol', color: PRESET_PASTEL_COLORS[2].value },
                { id: 'ev5', day: 'MARTES', startTime: '15:00', endTime: '17:00', subject: 'GOP', teacher: 'Prof. Estrella', color: PRESET_PASTEL_COLORS[3].value },
                { id: 'ev6', day: 'VIERNES', startTime: '07:00', endTime: '09:00', subject: 'Estrategia', teacher: 'Prof. Y', color: PRESET_PASTEL_COLORS[4].value },
            ];
            try {
                const docRef = db.collection('users').doc(userId);
                const docSnap = await docRef.get();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.timetable && Array.isArray(data.timetable)) {
                        timetableData = data.timetable;
                        console.log("Datos del horario cargados desde Firebase.", timetableData);
                    } else {
                        timetableData = [...defaultTimetable];
                        console.log("No se encontraron datos de horario en Firebase, usando predeterminados y guardando.");
                        await saveTimetableData(); // Save defaults if timetable field is missing or not an array
                    }
                } else {
                    timetableData = [...defaultTimetable];
                    console.log("No se encontró documento de usuario para horario, usando predeterminados y guardando.");
                    await saveTimetableData(); // Save defaults if user document doesn't exist
                }
            } catch (error) {
                console.error("Error cargando datos del horario desde Firebase:", error);
                timetableData = [...defaultTimetable]; // Fallback to defaults
                alert("Error al cargar datos del horario. Se usarán valores por defecto.");
            }
        }
        
        async function saveTimetableData() {
            try {
                await db.collection('users').doc(userId).set({
                    timetable: timetableData 
                }, { merge: true }); // Merge to avoid overwriting other data like 'ingresos'
                console.log("Datos del horario guardados en Firebase.");
            } catch (e) {
                console.error("Error guardando datos del horario en Firebase:", e);
                alert("Error al guardar datos del horario en la nube.");
            }
        }

        function renderTimetable() { 
            const gridContainer = document.getElementById('timetableGrid'); 
            if (!gridContainer) return; 
            gridContainer.innerHTML = ''; 
            const cornerDiv = document.createElement('div'); 
            cornerDiv.className = 'timetable-grid-corner'; 
            gridContainer.appendChild(cornerDiv); 
            TIMETABLE_DAYS.forEach((day, index) => { 
                const dayHeader = document.createElement('div'); 
                dayHeader.className = 'timetable-grid-header'; 
                dayHeader.textContent = day; 
                dayHeader.style.gridColumn = `${index + 2}`; 
                dayHeader.style.gridRow = '1'; 
                gridContainer.appendChild(dayHeader); 
            }); 
            for (let hour = TIMETABLE_START_HOUR; hour <= TIMETABLE_END_HOUR; hour++) { 
                const timeLabel = document.createElement('div'); 
                timeLabel.className = 'timetable-grid-time-label'; 
                timeLabel.textContent = `${String(hour).padStart(2, '0')}:00`; 
                timeLabel.style.gridColumn = '1'; 
                timeLabel.style.gridRow = `${hour - TIMETABLE_START_HOUR + 2}`; 
                gridContainer.appendChild(timeLabel); 
            } 
            timetableData.forEach(event => { 
                const eventDiv = document.createElement('div'); 
                eventDiv.className = 'timetable-grid-event'; 
                eventDiv.dataset.eventId = event.id; 
                eventDiv.style.backgroundColor = event.color || DEFAULT_EVENT_COLOR; 
                eventDiv.innerHTML = `<span class="subject-name">${event.subject}</span><span class="teacher-name">${event.teacher || ''}</span>`; 
                eventDiv.addEventListener('click', () => openEventModal('timetable', event.id)); 
                const dayIndex = TIMETABLE_DAYS.indexOf(event.day.toUpperCase()); 
                if (dayIndex === -1) return;  
                eventDiv.style.gridColumn = `${dayIndex + 2}`;  
                const startHourEvent = parseInt(event.startTime.split(':')[0]); 
                const endHourEvent = parseInt(event.endTime.split(':')[0]); 
                const startRow = startHourEvent - TIMETABLE_START_HOUR + 2; 
                const endRow = endHourEvent - TIMETABLE_START_HOUR + 2;  
                if (startRow < 2 || endRow <= startRow || endRow > (TIMETABLE_END_HOUR - TIMETABLE_START_HOUR + 2 + 1) ) return;  
                eventDiv.style.gridRow = `${startRow} / ${endRow}`; 
                gridContainer.appendChild(eventDiv); 
            }); 
        }
        
        function populateTimeSelect(selectElement, startHour, endHour, selectedValue, isEndTime = false) { 
            selectElement.innerHTML = ''; 
            const limit = isEndTime ? endHour + 1 : endHour; 
            for (let h = startHour; h <= limit; h++) { 
                const timeStr = `${String(h).padStart(2, '0')}:00`; 
                const option = document.createElement('option'); 
                option.value = timeStr; 
                option.textContent = timeStr; 
                if (timeStr === selectedValue) option.selected = true; 
                selectElement.appendChild(option); 
            } 
        }
        
        // --- FUNCIONES DEL CALENDARIO PRINCIPAL ---
        async function loadCalendarEventsData() {
            console.log("Intentando cargar eventos del calendario desde Firebase...");
            try {
                const docRef = db.collection('users').doc(userId);
                const docSnap = await docRef.get();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.calendarEvents && Array.isArray(data.calendarEvents)) {
                        calendarEventsData = data.calendarEvents;
                        console.log("Eventos del calendario cargados desde Firebase.", calendarEventsData);
                    } else {
                        calendarEventsData = []; // Default to empty if field missing or not array
                        console.log("No se encontraron eventos de calendario, inicializando como vacío y guardando.");
                        await saveCalendarEventsData();
                    }
                } else {
                    calendarEventsData = [];
                    console.log("No se encontró documento de usuario para calendario, inicializando como vacío y guardando.");
                    await saveCalendarEventsData();
                }
            } catch (error) {
                console.error("Error cargando eventos del calendario desde Firebase:", error);
                calendarEventsData = []; // Fallback
                alert("Error al cargar eventos del calendario. Se usarán valores por defecto.");
            }
        }

        async function saveCalendarEventsData() {
            try {
                await db.collection('users').doc(userId).set({
                    calendarEvents: calendarEventsData 
                }, { merge: true });
                console.log("Eventos del calendario guardados en Firebase.");
            } catch (e) {
                console.error("Error guardando eventos del calendario en Firebase:", e);
                alert("Error al guardar eventos del calendario en la nube.");
            }
        }

        function getCalendarProgressBarColor(percentage) {
            if (percentage >= 100) return 'var(--accent-green-neon)'; 
            if (percentage >= 75) return 'var(--cal-progress-q4)';
            if (percentage >= 50) return 'var(--cal-progress-q3)';
            if (percentage >= 25) return 'var(--cal-progress-q2)';
            return 'var(--cal-progress-q1)';
        }

        function updateCalendarDayProgressBar() { 
            const today = new Date();
            const hours = today.getHours();
            const minutes = today.getMinutes();
            const totalMinutesDay = hours * 60 + minutes;
            const maxMinutesDay = 24 * 60;
            const percentageDay = (totalMinutesDay / maxMinutesDay) * 100;

            const dayProgressBarCal = document.getElementById('day-progress-bar-cal');
            const dayTextCal = document.getElementById('day-text-cal');
            
            if (dayProgressBarCal && dayTextCal) {
                const color = getCalendarProgressBarColor(percentageDay);
                dayProgressBarCal.style.width = `${percentageDay}%`;
                dayProgressBarCal.style.backgroundColor = color;
                dayProgressBarCal.style.boxShadow = `0 0 6px 1px ${color}`; 
                dayTextCal.textContent = `${percentageDay.toFixed(0)}%`;
            }
        }

        function updateCalendarProgressBars() { 
            const today = new Date();const year = today.getFullYear();const month = today.getMonth(); const day = today.getDate();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const percentageMonth = (day / daysInMonth) * 100;

            const monthProgressBarCal = document.getElementById('month-progress-bar-cal');
            const monthTextCal = document.getElementById('month-text-cal');
            if(monthProgressBarCal && monthTextCal){
                const colorMonth = getCalendarProgressBarColor(percentageMonth);
                monthProgressBarCal.style.width = `${percentageMonth}%`;
                monthProgressBarCal.style.backgroundColor = colorMonth;
                monthProgressBarCal.style.boxShadow = `0 0 6px 1px ${colorMonth}`; 
                monthTextCal.textContent = `${percentageMonth.toFixed(0)}%`;
            }
            
            updateCalendarDayProgressBar(); 

            const startOfYear = new Date(year, 0, 1); const diff = today - startOfYear; const daysPassed = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1; 
            const isLeapYear = (year % 4 == 0 && year % 100 != 0) || (year % 400 == 0); const daysInYear = isLeapYear ? 366 : 365;
            const percentageYear = (daysPassed / daysInYear) * 100;
            
            const yearProgressBarCal = document.getElementById('year-progress-bar-cal');
            const yearTextCal = document.getElementById('year-text-cal');
            if(yearProgressBarCal && yearTextCal){
                const colorYear = getCalendarProgressBarColor(percentageYear);
                yearProgressBarCal.style.width = `${percentageYear}%`;
                yearProgressBarCal.style.backgroundColor = colorYear;
                yearProgressBarCal.style.boxShadow = `0 0 6px 1px ${colorYear}`; 
                yearTextCal.textContent = `${percentageYear.toFixed(0)}%`;
            }
        }

        function initializeMainCalendar() {
            // loadCalendarEventsData(); // Ya se llama en initializeApp
            const calendarEl = document.getElementById('mainCalendar');
            if (!calendarEl) { console.error("Elemento #mainCalendar no encontrado."); return; }
            const todayISO = new Date().toISOString().slice(0,10);
            
            mainCalendarInstance = new FullCalendar.Calendar(calendarEl, {
                locale: 'es', 
                initialView: 'dayGridMonth',
                initialDate: new Date(), 
                headerToolbar: { left: 'prev,next today', center: '', right: '' },
                buttonText: { today: 'Hoy' },
                eventSources: [
                    { 
                        url: 'https://www.calendarlabs.com/ical-calendar/ics/42/colombia-holidays.ics',
                        format: 'ics',
                        failure: function() { console.warn('No se pudieron cargar los festivos de Colombia.'); },
                        color: 'var(--accent-orange)', display: 'background', id: 'colombia-holidays'
                    },
                    { events: (fetchInfo, successCallback) => { successCallback(calendarEventsData.map(ev => ({...ev, borderColor: ev.color }))); }, id: 'user-events' }
                ],
                editable: false, 
                selectable: true, 
                selectMirror: true,
                selectAllow: function(selectInfo) { 
                    const selectedDate = new Date(selectInfo.start);
                    selectedDate.setHours(23,59,59,999); 
                    const currentDate = new Date();
                    currentDate.setHours(0,0,0,0);
                    return selectedDate >= currentDate;
                }, 
                eventClick: function(info) {
                    const today = new Date(); today.setHours(0,0,0,0); 
                    if (info.event.source && info.event.source.id === 'user-events') {
                        const canEdit = new Date(info.event.startStr.slice(0,10) + "T00:00:00") >= today; 
                        openEventModal('calendar', info.event.id, info.event.startStr, canEdit);
                    } else if (info.event.title) {
                        alert(`Festivo: ${info.event.title}`); 
                    }
                },
                select: function(info) { 
                     openEventModal('calendar', null, info.startStr, true); 
                     if (mainCalendarInstance) mainCalendarInstance.unselect(); 
                },
                datesSet: function(dateInfo) {
                     updateCalendarProgressBars(); 
                     updateTodayTasksList();
                }
            });
            mainCalendarInstance.render();
            updateCalendarProgressBars();
            updateTodayTasksList(); 
        }
        
        function updateTodayTasksList() { 
            const todayStr = new Date().toISOString().slice(0, 10); 
            const tasksListEl = document.getElementById('today-tasks-list'); 
            if (!tasksListEl) return;
            tasksListEl.innerHTML = ''; 
            const todayEvents = calendarEventsData.filter(event => { 
                const eventStartStr = event.start.slice(0, 10); 
                return eventStartStr === todayStr; 
            }); 
            if (todayEvents.length > 0) { 
                todayEvents.forEach(event => { 
                    const li = document.createElement('li'); 
                    li.textContent = `${event.title}`; 
                    li.style.color = event.color; 
                    li.style.borderLeft = `3px solid ${event.color}`; 
                    li.style.paddingLeft = '8px'; 
                    li.style.marginBottom = '5px'; 
                    tasksListEl.appendChild(li); 
                }); 
            } else { 
                tasksListEl.innerHTML = '<li style="color: var(--text-secondary);">No hay actividades programadas para hoy.</li>'; 
            } 
        }

        // --- MODAL UNIFICADO ---
        function openEventModal(type, eventId = null, dateStr = null, canEditCalendarDate = true) { 
            currentEditingEventType = type;
            currentEditingEventId = eventId;
            eventForm.reset();
            modalEventTypeInput.value = type;

            modalTimetableFields.style.display = (type === 'timetable') ? 'block' : 'none';
            modalCalendarFields.style.display = (type === 'calendar') ? 'block' : 'none';
            
            eventModalTitle.textContent = eventId ? `Editar ${type === 'timetable' ? 'Clase' : 'Actividad'}` : `Añadir Nueva ${type === 'timetable' ? 'Clase' : 'Actividad'}`;
            
            modalEventColorSelect.innerHTML = '';
            PRESET_PASTEL_COLORS.forEach(colorObj => {
                const option = document.createElement('option'); option.value = colorObj.value; option.textContent = colorObj.name; option.style.backgroundColor = colorObj.value;
                if (['#FFFFE0', '#E6E6FA', '#F5F5DC', '#FFDAB9', '#FFB6C1'].includes(colorObj.value)) { option.style.color = '#333';} else {option.style.color = 'var(--text-primary)';}
                modalEventColorSelect.appendChild(option);
            });

            const todayISO = new Date().toISOString().slice(0,10);

            if (type === 'timetable') {
                modalEventDaySelect.innerHTML = ''; TIMETABLE_DAYS.forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d; modalEventDaySelect.appendChild(o); });
                const defaultStartT = `${String(TIMETABLE_START_HOUR).padStart(2, '0')}:00`;
                const defaultEndT = `${String(Math.min(TIMETABLE_START_HOUR + 1, TIMETABLE_END_HOUR + 1)).padStart(2, '0')}:00`;
                populateTimeSelect(modalEventStartTimeSelect, TIMETABLE_START_HOUR, TIMETABLE_END_HOUR, defaultStartT);
                populateTimeSelect(modalEventEndTimeSelect, TIMETABLE_START_HOUR, TIMETABLE_END_HOUR + 1, defaultEndT, true);

                if (eventId) {
                    const event = timetableData.find(e => e.id === eventId);
                    if (event) {
                        modalEventIdInput.value = event.id; modalEventTitleInput.value = event.subject; modalEventTeacherInput.value = event.teacher || '';
                        modalEventDaySelect.value = event.day; modalEventStartTimeSelect.value = event.startTime; modalEventEndTimeSelect.value = event.endTime;
                        modalEventColorSelect.value = event.color || DEFAULT_EVENT_COLOR;
                    }
                } else {
                     modalEventTitleInput.placeholder = "Nombre de la Materia";
                     modalEventColorSelect.value = DEFAULT_EVENT_COLOR;
                }
            } else if (type === 'calendar') {
                modalEventAllDayCheckbox.checked = true; 
                [modalEventStartTimeCalInput.parentElement, modalEventEndTimeCalInput.parentElement, modalEventEndDateInput.parentElement, modalEventAllDayCheckbox.parentElement].forEach(el => {if(el) el.classList.add('hidden-field')});
                
                modalEventStartDateInput.min = todayISO; 

                if (eventId) {
                    const event = calendarEventsData.find(e => e.id === eventId);
                    if (event) {
                        modalEventIdInput.value = event.id; modalEventTitleInput.value = event.title;
                        const eventStartDate = event.start.slice(0,10);
                        modalEventStartDateInput.value = eventStartDate; 
                        modalEventColorSelect.value = event.color || DEFAULT_EVENT_COLOR;
                        modalEventStartDateInput.disabled = !canEditCalendarDate; 
                         if (!canEditCalendarDate) {
                            modalEventStartDateInput.min = eventStartDate; 
                        }
                    }
                } else { 
                    modalEventTitleInput.placeholder = "Nombre de la Actividad";
                    modalEventStartDateInput.value = dateStr && dateStr >= todayISO ? dateStr.slice(0,10) : todayISO;
                    modalEventColorSelect.value = DEFAULT_EVENT_COLOR;
                    modalEventStartDateInput.disabled = false;
                }
            }
            deleteEventBtn.style.display = eventId ? 'block' : 'none';
            eventModalOverlay.classList.add('active');
        }
        
        function closeEventModal() { eventModalOverlay.classList.remove('active'); }
        
        eventForm.addEventListener('submit', async function(e) { // Made async
            e.preventDefault(); 
            const id = modalEventIdInput.value; 
            const type = modalEventTypeInput.value;
            const title = modalEventTitleInput.value.trim(); 
            const color = modalEventColorSelect.value; 
            if (!title) { alert("El título/materia es obligatorio."); return; } 

            if (type === 'timetable') {
                const teacher = modalEventTeacherInput.value.trim(); 
                const day = modalEventDaySelect.value; 
                const startTime = modalEventStartTimeSelect.value; 
                const endTime = modalEventEndTimeSelect.value; 
                const startHour = parseInt(startTime.split(':')[0]); 
                const endHour = parseInt(endTime.split(':')[0]); 
                if (startHour >= endHour) { alert("La hora de fin debe ser posterior a la hora de inicio."); return; } 
                const collision = timetableData.find(ev => { if (id && ev.id === id) return false; return ev.day === day && startHour < parseInt(ev.endTime.split(':')[0]) && endHour > parseInt(ev.startTime.split(':')[0]); }); 
                if (collision) { alert("Conflicto de horario: Ya existe un evento en ese rango de tiempo."); return; } 
                const newEventData = { subject: title, teacher, day, startTime, endTime, color }; 
                if (id) { 
                    const eventIndex = timetableData.findIndex(e => e.id === id); 
                    if (eventIndex > -1) timetableData[eventIndex] = { ...timetableData[eventIndex], ...newEventData }; 
                } else { 
                    timetableData.push({ id: 'ev_tt_' + Date.now(), ...newEventData }); 
                } 
                await saveTimetableData(); 
                renderTimetable(); 
            } else if (type === 'calendar') {
                const startDate = modalEventStartDateInput.value;
                const todayISO = new Date().toISOString().slice(0,10);
                
                if (startDate < todayISO && !id) { 
                    alert("No se pueden añadir actividades a días pasados.");
                    return;
                }
                const existingEvent = id ? calendarEventsData.find(e=>e.id===id) : null;
                if (id && existingEvent && existingEvent.start.slice(0,10) < todayISO && startDate !== existingEvent.start.slice(0,10)) {
                     alert("No se puede cambiar la fecha de un evento pasado.");
                     modalEventStartDateInput.value = existingEvent.start.slice(0,10); 
                     return;
                }

                const newCalEventData = { title, start: startDate, allDay: true, color, id: id || ('ev_cal_' + Date.now()) };
                
                if (id) {
                    const eventIndex = calendarEventsData.findIndex(e => e.id === id);
                    if (eventIndex > -1) calendarEventsData[eventIndex] = newCalEventData;
                } else {
                    calendarEventsData.push(newCalEventData);
                }
                await saveCalendarEventsData(); 
                if(mainCalendarInstance) mainCalendarInstance.refetchEvents('user-events'); 
                updateTodayTasksList();
            }
            closeEventModal(); 
        });
        
        cancelEventBtn.addEventListener('click', closeEventModal);
        
        deleteEventBtn.addEventListener('click', async function() { // Made async
            if (!currentEditingEventId) return; 
            if (confirm("¿Seguro que quieres eliminar este evento? Esto también lo eliminará de la nube.")) { 
                if (currentEditingEventType === 'timetable') { 
                    timetableData = timetableData.filter(e => e.id !== currentEditingEventId); 
                    await saveTimetableData(); 
                    renderTimetable(); 
                } else if (currentEditingEventType === 'calendar') { 
                    calendarEventsData = calendarEventsData.filter(e => e.id !== currentEditingEventId);
                    await saveCalendarEventsData(); 
                    if(mainCalendarInstance) mainCalendarInstance.refetchEvents('user-events'); 
                    updateTodayTasksList(); 
                } 
                closeEventModal(); 
            }  
        });
        
        if (addTimetableEventBtnGlobal) { addTimetableEventBtnGlobal.addEventListener('click', () => openEventModal('timetable')); }
        if (addCalendarEventBtn) { addCalendarEventBtn.addEventListener('click', () => {
            const todayStr = new Date().toISOString().slice(0,10);
            openEventModal('calendar', null, todayStr, true); 
        });}

        // --- INICIALIZACIÓN ---
        async function initializeApp() { // Made async
            console.log("Inicializando aplicación...");
            showPage(defaultPage); 
            updateCurrentMonthDisplayDOM_Ingresos(); 

            // Cargar todos los datos de Firebase
            await Promise.all([
                loadData_Ingresos(),
                loadTimetableData(),
                loadCalendarEventsData()
            ]);
            console.log("Todos los datos iniciales cargados.");

            // Lógica de Ingresos
            checkForMonthlyResetLogic_Ingresos(); // Esto podría necesitar acceso a datos ya cargados
            if(elIngresos.overallTargetInput) {
                elIngresos.overallTargetInput.addEventListener('change', async () => { // Made async
                    const newTarget = parseFloat(elIngresos.overallTargetInput.value); 
                    if (!isNaN(newTarget) && newTarget > 0) { 
                        currentOverallTargetCOP = newTarget; 
                        await saveData_Ingresos(); 
                        updateAllDisplays_Ingresos(); 
                    } else { 
                        elIngresos.overallTargetInput.value = currentOverallTargetCOP; 
                    } 
                }); 
            }
            getDailyExchangeRate_Ingresos().then(() => { 
                updateAllDisplays_Ingresos(); 
                if(elIngresos.addMoneyButton) elIngresos.addMoneyButton.disabled = false; 
            }).catch(err => { 
                console.error("Error initializing exchange rate:", err); 
                if(elIngresos.addMoneyButton) elIngresos.addMoneyButton.disabled = false; 
                updateInputPlaceholder_Ingresos(); 
                updateAllDisplays_Ingresos(); 
            }); 
            if(elIngresos.addMoneyButton) elIngresos.addMoneyButton.addEventListener('click', addMoney_Ingresos); 
            if(elIngresos.moneyInput) elIngresos.moneyInput.addEventListener('keypress', e => { if (e.key === 'Enter') addMoney_Ingresos(); }); 
            if(elIngresos.clearHistoryButton) elIngresos.clearHistoryButton.addEventListener('click', clearHistory_Ingresos); 
            if(elIngresos.currencySelector) {
                elIngresos.currencySelector.addEventListener('change', async (event) => { // Made async
                    selectedInputCurrencyIngresos = event.target.value; 
                    updateInputPlaceholder_Ingresos(); 
                    await saveData_Ingresos(); 
                }); 
            }
            
            // Lógica de Horario
            renderTimetable(); 

            // Lógica de Calendario (initializeMainCalendar se llama dentro de showPage si es la página activa)
            // Si la página por defecto es calendario, ya se inicializará allí.
            // Si no, se inicializará cuando el usuario navegue a ella.
            // Asegurarse de que `calendarEventsData` esté poblado antes de `initializeMainCalendar`.
            if (defaultPage === 'calendario-page' && mainCalendarInstance) {
                 mainCalendarInstance.refetchEvents('user-events');
                 updateTodayTasksList();
            }
            console.log("Aplicación inicializada.");
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
```
